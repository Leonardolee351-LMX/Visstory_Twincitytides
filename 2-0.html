<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Folded Metropolis: Complete Edition</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0E7490', // Cyan 700
                        secondary: '#06B6D4', // Cyan 500
                        accent: '#ECFEFF', // Cyan 50 (Added from Part 3)
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    // Animations from Part 3
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'swap-out': 'swapOut 3s infinite', 
                        'swap-in': 'swapIn 3s infinite',   
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(40px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        swapOut: { '0%, 45%': { opacity: 1, transform: 'scale(1)' }, '50%, 95%': { opacity: 0, transform: 'scale(0.5)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                        swapIn: { '0%, 45%': { opacity: 0, transform: 'scale(0.5)' }, '50%, 95%': { opacity: 1, transform: 'scale(1)' }, '100%': { opacity: 0, transform: 'scale(0.5)' } }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            /* --- DESIGN TOKENS --- */
            --primary-color: #0E7490;
            --primary-light: #22D3EE;
            --secondary-color: #06B6D4;
            --accent-bg: #F0F9FF;
            
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;

            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            --glass-blur: blur(16px);

            /* Dimensions */
            --panel-width: 400px;
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            /* Part 1 Specific Colors */
            --type-railway: #2563EB; 
            --type-hsr: #E11D48;     
            --type-road: #059669;    
            --type-water: #0284C7;   
            --type-new: #D97706;     
            --type-air: #7C3AED;     
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        /* --- UNIFIED SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(148, 163, 184, 0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(100, 116, 139, 0.8); }

        /* Part 3 Specific Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #0E7490; }

        .bento-card {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .bento-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 40px -10px rgba(14, 116, 144, 0.15);
            border-color: #22D3EE;
        }

        /* --- CHAPTER NAVIGATOR (CAPSULE) --- */
        .chapter-nav-container {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 4px;
            border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            gap: 4px;
        }

        .nav-btn {
            border: none;
            background: transparent;
            padding: 8px 20px;
            border-radius: 100px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn.active {
            background: var(--text-primary);
            color: white;
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.15);
        }

        .nav-btn:hover:not(.active) {
            background: rgba(0,0,0,0.04);
            color: var(--text-primary);
        }

        /* --- VIEW CONTAINERS --- */
        .view-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: opacity 0.4s ease;
        }
        .view-hidden {
            opacity: 0; pointer-events: none; z-index: -1; visibility: hidden;
        }
        .view-active {
            opacity: 1; pointer-events: auto; z-index: 1; visibility: visible;
        }
        
        /* Map Container Specifics */
        .full-screen-map {
            width: 100%; height: 100%; background: #eef2f6;
        }
        
        /* Part 2 Specific Layout Fixes */
        #map-part2-inner {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 0; /* Map stays behind UI */
        }
        #root {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; /* Let clicks pass through empty areas to map */
        }
        /* Re-enable pointer events for the UI panel inside #root */
        #root .glass-panel, #root .legend-unified {
            pointer-events: auto;
        }

        /* --- UNIFIED PANEL STYLES --- */
        .glass-panel {
            position: absolute;
            top: 24px;
            left: 24px;
            bottom: 24px;
            width: var(--panel-width);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .panel-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }

        /* --- TYPOGRAPHY SYSTEM --- */
        .main-title-large {
            font-size: 20px; font-weight: 800; 
            color: var(--text-primary);
            letter-spacing: -0.5px; margin-bottom: 4px;
            line-height: 1.2;
        }
        .main-title-small {
            font-size: 11px; font-weight: 600; color: var(--text-secondary); 
            text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.8;
            margin-bottom: 24px;
        }
        .header-section { margin-bottom: 24px; }
        
        .current-year {
            font-size: 56px; font-family: 'JetBrains Mono', monospace; font-weight: 700;
            color: var(--primary-color); line-height: 1; letter-spacing: -3px;
            margin-bottom: 4px;
        }
        .subtitle { 
            font-size: 13px; color: var(--text-secondary); font-weight: 500; 
            line-height: 1.5; min-height: 2.8em;
        }

        /* --- COMPONENT: SELECT --- */
        select.compact-select {
            padding: 10px 12px; border-radius: var(--radius-sm); 
            border: 1px solid rgba(0,0,0,0.08);
            font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 500;
            color: var(--text-primary); background-color: rgba(255,255,255,0.8);
            width: 100%; outline: none; transition: all 0.2s; 
            margin-bottom: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        select.compact-select:hover { border-color: rgba(0,0,0,0.2); }
        select.compact-select:focus { border-color: var(--primary-color); ring: 2px solid var(--primary-light); }

        /* --- COMPONENT: SLIDER (Unified) --- */
        .slider-container { width: 100%; padding: 0 2px; margin-top: 20px; margin-bottom: 20px; }
        input[type=range] { 
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; 
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; 
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px; width: 20px; border-radius: 50%; background: white;
            border: 2px solid var(--primary-color); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            -webkit-appearance: none; margin-top: -7px; 
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .slider-labels { 
            display: flex; justify-content: space-between; margin-top: 8px; 
            font-family: 'JetBrains Mono', monospace; font-size: 10px; 
            color: var(--text-muted); font-weight: 500; 
        }

        /* --- COMPONENT: STATS & EVENTS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .stats-grid.three-cols { grid-template-columns: 1fr 1fr 1fr; }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.6); padding: 16px; border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center;
        }
        .stat-item.highlight { 
            background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(224, 242, 254, 0.5)); 
            border-color: #BAE6FD; 
        }
        .stat-item label { 
            display: block; font-size: 10px; text-transform: uppercase; 
            color: var(--text-muted); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px;
        }
        .stat-item .value { 
            font-family: 'JetBrains Mono', monospace; font-size: 24px; 
            font-weight: 700; color: var(--text-primary); line-height: 1.1; 
        }
        .stat-item .unit { font-size: 11px; color: var(--text-secondary); font-weight: 500; margin-left: 2px; }
        .stat-item .sub-value { font-size: 11px; margin-top: 4px; display: block; font-weight: 600; }

        .event-section-title { 
            font-size: 11px; font-weight: 700; color: var(--text-secondary); 
            margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; 
            display: flex; align-items: center; gap: 8px; margin-top: 12px;
        }
        .event-section-title::before { 
            content: ''; width: 4px; height: 4px; background: var(--secondary-color); border-radius: 50%; 
        }
        
        .event-card { 
            background: white; border: 1px solid rgba(0,0,0,0.05); 
            border-radius: var(--radius-md); padding: 16px; margin-bottom: 10px; 
            transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .event-card:hover { 
            transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); 
        }
        .event-card.active {
            border-color: var(--primary-color);
            background-color: var(--accent-bg);
        }
        
        .event-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .event-tag { 
            font-size: 9px; font-weight: 700; text-transform: uppercase; 
            color: var(--primary-color); background: var(--accent-bg); 
            padding: 3px 8px; border-radius: 100px; 
        }
        .event-date { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); }
        .event-title { font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; }
        .event-image { width: 100%; height: 140px; object-fit: cover; border-radius: var(--radius-sm); margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .event-impact-box { background: #F8FAFC; border-radius: 6px; padding: 10px 12px; margin-top: 10px; font-size: 12px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 4px; border: 1px solid rgba(0,0,0,0.04); }
        .narrative-box { font-size: 13px; line-height: 1.6; color: var(--text-secondary); background: rgba(255,255,255,0.5); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.6); }

        .back-btn { 
            font-size: 12px; color: var(--primary-color); cursor: pointer; 
            background: white; padding: 6px 14px; border-radius: 100px; 
            font-weight: 600; display: none; margin-bottom: 16px; 
            align-self: flex-start; box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            border: 1px solid rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .back-btn:hover { background: var(--accent-bg); }

        /* --- LEGENDS & TOOLTIPS --- */
        .legend-unified {
            position: absolute; bottom: 32px; right: 32px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            padding: 16px 20px; border-radius: var(--radius-md); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 500; border: 1px solid rgba(255,255,255,0.6);
            min-width: 180px;
        }
        .legend-title { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; color: var(--text-muted); letter-spacing: 0.5px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 11px; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
        .legend-item:hover { opacity: 0.7; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .legend-line { width: 12px; height: 3px; margin-right: 8px; border-radius: 2px; }

        .tooltip {
            position: absolute; background: rgba(255, 255, 255, 0.95); padding: 0;
            border-radius: var(--radius-sm); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.05);
            pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 2000;
            border: 1px solid rgba(255,255,255,0.8); backdrop-filter: blur(8px);
            font-family: 'Inter', sans-serif; width: 260px; overflow: hidden;
        }
        .tooltip-header { padding: 12px 16px 8px; font-size: 13px; font-weight: 700; color: #1A1A1A; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .tooltip-body { padding: 12px 16px; }
        .tooltip-meta { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 8px; }
        .tooltip-stat { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px; color: #333; }
        .tooltip-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .t-tag { font-size: 9px; padding: 2px 6px; background: #F1F5F9; color: var(--text-secondary); border-radius: 4px; font-weight: 600; border: 1px solid rgba(0,0,0,0.05); }
        
        /* --- MAP ELEMENTS --- */
        .node-group { cursor: pointer; transition: opacity 0.2s; }
        .node-group:hover { opacity: 0.8; }
        .map-label { 
            font-size: 10px; font-weight: 700; color: #334155; 
            text-align: center; white-space: nowrap; 
            text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff; 
            cursor: pointer; transition: all 0.2s; background: transparent; border: none; 
        }
        .map-label:hover { color: var(--primary-color); transform: scale(1.1); z-index: 1000; }
        
        .station-node { 
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* --- TAB SWITCHER (For Part 2) --- */
        .tab-group { 
            background: rgba(0,0,0,0.04); padding: 4px; border-radius: 100px; 
            display: flex; margin-bottom: 24px;
        }
        .tab-btn { 
            flex: 1; padding: 6px; text-align: center; font-size: 12px; 
            font-weight: 600; border-radius: 100px; color: var(--text-secondary); 
            cursor: pointer; transition: all 0.2s; border: none; background: transparent; 
        }
        .tab-btn.active { 
            background: white; color: var(--primary-color); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
        }

        /* --- UTILS --- */
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .custom-pin { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(14, 116, 144, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(14, 116, 144, 0); } 100% { box-shadow: 0 0 0 0 rgba(14, 116, 144, 0); } }
    </style>
</head>
<body>
    <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-[9999] w-[90%] max-w-2xl">
        <div class="bg-white/70 backdrop-blur-md border border-slate-200/50 shadow-lg rounded-2xl px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-primary rounded-full animate-pulse"></div>
                <span class="text-xs font-bold tracking-widest text-slate-800 uppercase font-mono">NBSB Research</span>
            </div>
            <div class="flex gap-4 md:gap-8">
                <a href="3-1.html" class="nav-link text-sm font-semibold transition-colors hover:text-primary" id="nav-3-1">Ë∑®Êó∂Á©∫ÂàÜÊûê</a>
                <a href="3-2.html" class="nav-link text-sm font-semibold transition-colors hover:text-primary" id="nav-3-2">ÁîüÊ¥ªÊµÅÂõæÈâ¥</a>
            </div>
            <button onclick="window.print()" class="hidden md:block text-slate-400 hover:text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"></path><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            </button>
        </div>
    </nav>

    <style>
        .nav-link { color: #64748b; position: relative; }
        .nav-link.active { color: #0E7490; }
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #0E7490;
            border-radius: 2px;
        }
        body { animation: fadeInPage 0.8s ease-out; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script>
        const currentFile = window.location.pathname.split("/").pop();
        if (currentFile === "3-1.html" || currentFile === "") {
            document.getElementById('nav-3-1').classList.add('active');
        } else if (currentFile === "3-2.html") {
            document.getElementById('nav-3-2').classList.add('active');
        }
    </script>

    <!-- CHAPTER NAVIGATION -->
    <div class="chapter-nav-container">
        <button id="nav-c1" class="nav-btn active" onclick="switchChapter(1)">
            1. Flows
        </button>
        <button id="nav-c2" class="nav-btn" onclick="switchChapter(2)">
            2. Analysis
        </button>
        <button id="nav-c3" class="nav-btn" onclick="switchChapter(3)">
            3. Dual City
        </button>
    </div>

    <!-- PART 1 CONTAINER (Vanilla JS / D3) -->
    <div id="view-part1" class="view-container view-active">
        <div id="map1" class="full-screen-map"></div>
        
        <div class="glass-panel">
            <div class="panel-scroll-area">
                <div class="main-title-group">
                    <div class="main-title-large">The Folded Metropolis</div>
                    <div class="main-title-small">Part 1: Cross-Border Evolution</div>
                </div>

                <div class="header-section">
                    <div class="title-group">
                        <div class="current-year" id="year-display">2017</div>
                        <div class="subtitle" id="year-subtitle">Traditional Railway Hegemony & Southbound Consumption</div>
                    </div>

                    <div class="slider-container">
                        <input type="range" id="year-slider" min="0" max="8" step="1" value="0">
                        <div class="slider-labels">
                            <span>2017</span><span>'19</span><span>'21</span><span>'23</span><span>'25</span>
                        </div>
                    </div>

                    <div class="selector-wrapper">
                        <select id="port-selector" class="compact-select">
                            <option value="overview">üîç Select Checkpoint / Overview</option>
                            <optgroup label="Railway / High Speed">
                                <option value="luohu">Lo Wu (Railway)</option>
                                <option value="futian">Lok Ma Chau Spur Line / Futian</option>
                                <option value="west_kowloon">West Kowloon (HSR)</option>
                                <option value="hung_hom">Hung Hom (Through Train)</option>
                            </optgroup>
                            <optgroup label="Road Control Points">
                                <option value="huanggang">Lok Ma Chau / Huanggang</option>
                                <option value="shenzhen_bay">Shenzhen Bay</option>
                                <option value="mankamto">Man Kam To</option>
                                <option value="shatoujiao">Sha Tau Kok</option>
                                <option value="liantang">Heung Yuen Wai / Liantang</option>
                            </optgroup>
                            <optgroup label="Water / Bridge">
                                <option value="hzmb">HZMB (Bridge)</option>
                                <option value="macau_ferry">Macau Ferry Terminal</option>
                                <option value="china_ferry">China Ferry Terminal</option>
                                <option value="tuen_mun">Tuen Mun Ferry Terminal</option>
                                <option value="kai_tak">Kai Tak Cruise Terminal</option>
                            </optgroup>
                            <optgroup label="Air">
                                <option value="airport">HK International Airport</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div id="back-btn" class="back-btn" onclick="resetView()">
                    <i class="fas fa-arrow-left"></i> Back to Overview
                </div>

                <div id="info-panel"></div>
            </div>
        </div>

        <div class="legend-unified">
            <div class="legend-title">Port Types</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-railway)"></div>Railway</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-hsr)"></div>High-Speed Rail</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-road)"></div>Road</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-water)"></div>Water/Bridge</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-new)"></div>New Port Type</div>
            <div class="legend-item"><div class="legend-color" style="background: var(--type-air)"></div>Airport</div>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <!-- PART 2 CONTAINER (React) -->
    <div id="view-part2" class="view-container view-hidden">
        <div id="root"></div>
    </div>

    <!-- PART 3 CONTAINER (React) -->
    <div id="view-part3" class="view-container view-hidden">
        <div id="root-part3" class="w-full h-full"></div>
    </div>

    <!-- SWITCHING LOGIC -->
    <script>
        function switchChapter(chapterId) {
            const part1 = document.getElementById('view-part1');
            const part2 = document.getElementById('view-part2');
            const part3 = document.getElementById('view-part3');
            
            const btn1 = document.getElementById('nav-c1');
            const btn2 = document.getElementById('nav-c2');
            const btn3 = document.getElementById('nav-c3');

            // Reset all
            part1.classList.add('view-hidden'); part1.classList.remove('view-active');
            part2.classList.add('view-hidden'); part2.classList.remove('view-active');
            part3.classList.add('view-hidden'); part3.classList.remove('view-active');
            
            btn1.classList.remove('active');
            btn2.classList.remove('active');
            btn3.classList.remove('active');

            // Activate specific
            if (chapterId === 1) {
                part1.classList.add('view-active');
                part1.classList.remove('view-hidden');
                btn1.classList.add('active');
                if (window.map1Instance) window.map1Instance.invalidateSize();
            } else if (chapterId === 2) {
                part2.classList.add('view-active');
                part2.classList.remove('view-hidden');
                btn2.classList.add('active');
                // Trigger resize for React map (Part 2)
                setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 100);
            } else if (chapterId === 3) {
                part3.classList.add('view-active');
                part3.classList.remove('view-hidden');
                btn3.classList.add('active');
            }
        }
    </script>

    <!-- PART 1 LOGIC (Vanilla JS + D3) -->
    <script>
        (function() {
            /* --- ANIMATION HELPERS (NEW) --- */
            function animateValue(obj, start, end, duration, decimals = 0) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    // EaseOutQuad
                    const easeProgress = 1 - (1 - progress) * (1 - progress);
                    
                    const current = start + (end - start) * easeProgress;
                    obj.innerHTML = current.toFixed(decimals);
                    
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        obj.innerHTML = end.toFixed(decimals);
                    }
                };
                window.requestAnimationFrame(step);
            }

            function triggerAnimations() {
                const counters = document.querySelectorAll('.counter');
                counters.forEach(counter => {
                    const target = parseFloat(counter.getAttribute('data-target'));
                    const decimals = parseInt(counter.getAttribute('data-decimals') || 0);
                    // Start from 0, animate to target over 800ms
                    animateValue(counter, 0, target, 800, decimals);
                });
            }
            /* -------------------------------- */

            const timeLabels = ["2017", "2018", "2019", "2020", "2021", "2022", "2023", "2024", "2025"];
            const yearSubtitles = {
                "2017": "Traditional Railway Hegemony & Southbound Consumption",
                "2018": "Year of Infrastructure & Traffic Highs",
                "2019": "Resilience & Divergence Amidst Social Unrest",
                "2020": "The Great Shutdown & Logistics Lifeline",
                "2021": "Digital Preparation in Isolation",
                "2022": "Network Optimization & East Rail Extension",
                "2023": "V-Shape Recovery & Model Reshaping",
                "2024": "Northbound Consumption & Structural Reversal",
                "2025": "Normalization of the 'One-Hour Living Circle'"
            };
            const csvData = {
                "2017": { total: 298935106, luohu: 81707959, futian: 59464480, airport: 50931408, huanggang: 28692687, shenzhen_bay: 40626957, hzmb: 0, west_kowloon: 0, liantang: 0, mankamto: 4240552, shatoujiao: 3086211, macau_ferry: 17317037, china_ferry: 7074940, kai_tak: 1682142, harbour: 54741, hung_hom: 3856027, tuen_mun: 696232 },
                "2018": { total: 314358682, luohu: 85115363, futian: 56323497, airport: 53377591, huanggang: 28625851, shenzhen_bay: 44288095, hzmb: 4817708, west_kowloon: 5270089, liantang: 0, mankamto: 4296002, shatoujiao: 3091355, macau_ferry: 16292987, china_ferry: 6838476, kai_tak: 1732800, harbour: 54712, hung_hom: 3826822, tuen_mun: 734910 },
                "2019": { total: 290820063, luohu: 78234223, futian: 50156488, airport: 52000000, huanggang: 24734863, shenzhen_bay: 41804243, hzmb: 13982464, west_kowloon: 16933543, liantang: 0, mankamto: 4038561, shatoujiao: 2801463, macau_ferry: 12000000, china_ferry: 5000000, kai_tak: 1500000, harbour: 50000, hung_hom: 3000000, tuen_mun: 600000 },
                "2020": { total: 18182281, luohu: 5670870, futian: 3519867, airport: 6000000, huanggang: 1692764, shenzhen_bay: 3262886, hzmb: 1259141, west_kowloon: 1045952, liantang: 50000, mankamto: 287118, shatoujiao: 198947, macau_ferry: 1000000, china_ferry: 500000, kai_tak: 100000, harbour: 10000, hung_hom: 300000, tuen_mun: 50000 },
                "2021": { total: 1000000, luohu: 0, futian: 0, airport: 800000, huanggang: 0, shenzhen_bay: 800000, hzmb: 150000, west_kowloon: 0, liantang: 0, mankamto: 0, shatoujiao: 0, macau_ferry: 0, china_ferry: 0, kai_tak: 0, harbour: 0, hung_hom: 0, tuen_mun: 0 },
                "2022": { total: 5300000, luohu: 0, futian: 0, airport: 1500000, huanggang: 0, shenzhen_bay: 930000, hzmb: 300000, west_kowloon: 0, liantang: 0, mankamto: 0, shatoujiao: 0, macau_ferry: 0, china_ferry: 0, kai_tak: 0, harbour: 0, hung_hom: 0, tuen_mun: 0 },
                "2023": { total: 212000000, luohu: 50000000, futian: 40000000, airport: 35000000, huanggang: 20000000, shenzhen_bay: 35000000, hzmb: 20000000, west_kowloon: 25000000, liantang: 12000000, mankamto: 3000000, shatoujiao: 1500000, macau_ferry: 8000000, china_ferry: 3000000, kai_tak: 1000000, harbour: 30000, hung_hom: 0, tuen_mun: 400000 },
                "2024": { total: 298500000, luohu: 65000000, futian: 45000000, airport: 45000000, huanggang: 25000000, shenzhen_bay: 40000000, hzmb: 30000000, west_kowloon: 30000000, liantang: 25000000, mankamto: 3500000, shatoujiao: 2000000, macau_ferry: 10000000, china_ferry: 4000000, kai_tak: 1200000, harbour: 40000, hung_hom: 0, tuen_mun: 500000 },
                "2025": { total: 315000000, luohu: 68000000, futian: 48000000, airport: 61000000, huanggang: 26000000, shenzhen_bay: 42000000, hzmb: 35000000, west_kowloon: 35000000, liantang: 30000000, mankamto: 4000000, shatoujiao: 2500000, macau_ferry: 11000000, china_ferry: 4500000, kai_tak: 1300000, harbour: 45000, hung_hom: 0, tuen_mun: 550000 }
            };
            const ports = {
                "luohu": { name: "Lo Wu", type: "railway", lat: 22.5293, lon: 114.1130, img: "images/ÁΩóÊπñÂè£Â≤∏.jpg", tags: ["Commuter", "Legacy", "Mass Transit"], brief: "The historic railway artery and busiest land crossing, connecting downtown Shenzhen directly." },
                "futian": { name: "Lok Ma Chau / Futian", type: "railway", lat: 22.5173, lon: 114.0665, img: "images/Á¶èÁî∞Âè£Â≤∏.jpg", tags: ["Business", "Metro", "CBD"], brief: "Seamless connection to Shenzhen's financial district via the Spur Line." },
                "huanggang": { name: "Lok Ma Chau / Huanggang", type: "road", lat: 22.5244, lon: 114.0722, img: "images/ÁöáÂ≤óÂè£Â≤∏.jpg", tags: ["24-Hour", "Road", "Bus"], brief: "A sleepless road crossing serving round-the-clock cross-boundary coaches." },
                "shenzhen_bay": { name: "Shenzhen Bay", type: "road", lat: 22.4939, lon: 113.9436, img: "images/Ê∑±Âú≥ÊπæÂè£Â≤∏.jpg", tags: ["Co-location", "Bridge", "West"], brief: "A vital road link connecting the western territories of both cities." },
                "mankamto": { name: "Man Kam To", type: "road", lat: 22.5367, lon: 114.1269, img: "images/ÊñáÈî¶Ê∏°.jpg", tags: ["Logistics", "Food Supply"], brief: "The critical lifeline for fresh food imports from the mainland." },
                "shatoujiao": { name: "Sha Tau Kok", type: "road", lat: 22.5488, lon: 114.2230, img: "images/Ê≤ôÂ§¥Ëßí.jpg", tags: ["Eastern", "Quiet", "Restricted"], brief: "A lower-volume crossing serving the eastern border zone." },
                "west_kowloon": { name: "West Kowloon (HSR)", type: "hsr", lat: 22.3029, lon: 114.1666, img: "images/È´òÈìÅË•ø‰πùÈæô.jpg", tags: ["High Speed", "City-Center", "Network"], brief: "High-speed rail terminus linking Hong Kong to the national network." },
                "hzmb": { name: "HZMB (Bridge)", type: "water", lat: 22.3160, lon: 113.9370, img: "images/Ê∏ØÁè†Êæ≥Â§ßÊ°•.jpg", tags: ["Mega-Project", "Driving", "Delta"], brief: "The world's longest sea crossing, integrating the Greater Bay Area." },
                "liantang": { name: "Heung Yuen Wai / Liantang", type: "new", lat: 22.555, lon: 114.156, img: "images/È¶ôÂõ≠Âõ¥Ëé≤Â°ò.jpg", tags: ["Modern", "Parking", "Logistics"], brief: "The first direct-access port for private cars and a key logistics node." },
                "airport": { name: "HK International Airport", type: "air", lat: 22.3080, lon: 113.9185, img: "images/È¶ôÊ∏ØÂõΩÈôÖÊú∫Âú∫.jpg", tags: ["Global", "Aviation", "Hub"], brief: "International gateway connecting Hong Kong to the world." },
                "macau_ferry": { name: "Macau Ferry Terminal", type: "water", lat: 22.2882, lon: 114.1523, img: "images/Ê∏ØÊæ≥ÂÆ¢ËΩÆÁ†ÅÂ§¥.jpg", tags: ["Sea", "Ferry", "Tradition"], brief: "The classic hydrofoil terminal serving Macau and Pearl River ports." },
                "china_ferry": { name: "China Ferry Terminal", type: "water", lat: 22.3003, lon: 114.1673, img: "images/‰∏≠ÂõΩÂÆ¢ËøêÁ†ÅÂ§¥.jpg", tags: ["Urban", "Tsim Sha Tsui", "Ferry"], brief: "Located in the heart of Kowloon, serving routes to the PRD." },
                "kai_tak": { name: "Kai Tak Cruise Terminal", type: "water", lat: 22.3073, lon: 114.2123, img: "images/ÂêØÂæ∑ÈÇÆËΩÆÁ†ÅÂ§¥.jpg", tags: ["Cruise", "Tourism", "Leisure"], brief: "A dedicated terminal for international cruise liners." },
                "hung_hom": { name: "Hung Hom (Through Train)", type: "railway", lat: 22.3032, lon: 114.1815, img: "images/Á∫¢Á£° (ÂüéÈôÖÁõ¥ÈÄöËΩ¶).jpg", tags: ["Legacy", "Intercity"], brief: "Former terminus for the Intercity Through Train (ceased 2024)." },
                "tuen_mun": { name: "Tuen Mun Ferry Terminal", type: "water", lat: 22.3712, lon: 113.9664, img: "images/Â±ØÈó®ÂÆ¢ËøêÁ†ÅÂ§¥.jpg", tags: ["Delta", "Ferry", "Regional"], brief: "Ferry terminal serving the Northwest New Territories." }
            };

            const db = {};
            timeLabels.forEach((year, index) => {
                const yData = csvData[year];
                let portStats = {};
                Object.keys(ports).forEach(pid => {
                    let annual = yData[pid] || 0;
                    let daily = (annual / 365).toFixed(0); 
                    let daily10k = (annual / 365 / 10000).toFixed(1);
                    let share = 0;
                    if (yData.total > 0 && annual > 0) share = ((annual / yData.total) * 100).toFixed(1);
                    let growth = "N/A";
                    if (index > 0) {
                        const prevYear = timeLabels[index - 1];
                        const prevVal = csvData[prevYear][pid];
                        if (prevVal > 0) growth = ((annual - prevVal) / prevVal * 100).toFixed(1);
                        else if (annual > 0) growth = "New"; 
                        else growth = "0";
                    }
                    let desc = "";
                    if (annual === 0) {
                        if (year === '2020' || year === '2021' || year === '2022') desc = "Services suspended due to pandemic restrictions. Maintained only limited emergency cargo or special clearance.";
                        else if (pid === 'west_kowloon' && parseInt(year) < 2018) desc = "West Kowloon Station under final construction. HSR Hong Kong Section not yet open.";
                        else if (pid === 'hzmb' && parseInt(year) < 2018) desc = "Bridge under final acceptance testing. Not yet open to traffic.";
                        else if (pid === 'liantang' && parseInt(year) < 2020) desc = "Heung Yuen Wai / Liantang Port under final construction.";
                        else desc = "No passenger traffic recorded for this port this year.";
                    } else {
                        if (year === '2017') {
                            if(pid === 'luohu') desc = "The absolute dominant gateway, handling 27% of traffic. Top choice for 'Southbound Consumption' flows.";
                            else if(pid === 'futian') desc = "Connected via Lok Ma Chau Spur Line, serving as a key hub for Futian CBD business travelers.";
                            else desc = "Under the 'One Trip Per Week' policy, operations were stable, serving traditional commuting and tourism needs.";
                        } else if (year === '2018') {
                            if(pid === 'west_kowloon') desc = "Opened Sep 23. The 'Co-location Arrangement' slashed clearance times, marking the start of the HSR era.";
                            else if(pid === 'hzmb') desc = "Opened Oct 24. The first direct land link to the west bank of the Pearl River, becoming a new landmark.";
                            else desc = "Driven by new infrastructure (HSR, Bridge), cross-border traffic hit historical highs.";
                        } else if (year === '2019') {
                            if(pid === 'west_kowloon' || pid === 'hzmb') desc = "Amidst social unrest, traffic here remained resilient due to closed management and security control.";
                            else if(pid === 'macau_ferry' || pid === 'china_ferry') desc = "Sea traffic shrank significantly due to social events, with passengers shifting to land or rail.";
                            else desc = "Traffic fluctuated due to social events in the second half, but essential commuting maintained basic operations.";
                        } else if (year === '2020') {
                            if(pid === 'shenzhen_bay' || pid === 'hzmb' || pid === 'airport') desc = "One of the few remaining open ports during the pandemic, serving as a vital 'lifeline' for essential travel.";
                            else if(pid === 'liantang') desc = "Cargo clearance started Aug 26 ('East-in East-out' strategy), securing stable goods supply to HK.";
                            else desc = "Passenger services suspended from Feb 4 due to COVID-19. Traffic fell off a cliff; cargo only.";
                        } else if (year === '2021' || year === '2022') desc = "Continued closure. Customs utilized this period to upgrade facilities, including 'Contactless e-Channel'.";
                        else if (year === '2023') {
                            if(pid === 'liantang') desc = "Passenger service opened Feb 6. Rapidly became popular for cyclists and drivers due to direct parking access.";
                            else if(pid === 'hzmb') desc = "'Northbound Travel for HK Vehicles' launched in July, driving bridge traffic to new highs.";
                            else desc = "Full reopening in Feb triggered a 'V-shaped' rebound as 3 years of pent-up demand was released.";
                        } else if (year === '2024' || year === '2025') {
                            if(pid === 'luohu' || pid === 'futian') desc = "'Northbound Consumption' is now the norm. Weekends see immense 'tidal' pressure on these traditional hubs.";
                            else if(pid === 'west_kowloon') desc = "'Flexi-trip' extended to Shenzhen North. HSR is becoming 'metro-like', favored for twin-city living.";
                            else desc = "Within the 'One-Hour Living Circle', the port is no longer just a checkpoint, but a lifestyle hub.";
                        }
                    }
                    portStats[pid] = { annual: annual, daily: parseInt(daily), daily10k: parseFloat(daily10k), share: parseFloat(share), growth: growth, desc: desc, status: annual > 0 ? "Active" : "Closed" };
                });
                let events = [];
                if (year === "2017") events.push({ tag: "Policy", date: "All Year", title: "'One Trip Per Week' Normalized", desc: "Restriction on Shenzhen residents visiting HK (implemented 2015) became the norm to ease community pressure.", impact: "Limited Shenzhen visitor frequency. Mainland traffic remained southbound and concentrated at Lo Wu (Traditional Railway Hegemony).", img: "2017‰∏ÄÂë®‰∏ÄË°å.jpg" });
                if (year === "2018") {
                    events.push({ tag: "Infra", date: "2018-09-23", title: "HSR Opening & Co-location", desc: "HK connected to National HSR Network. 'Co-location Arrangement' at West Kowloon enabled CBD-to-CBD express.", impact: "Created new demand and diverted sea passengers. 14 mins to Futian broke traditional time barriers.", img: "2018‰∏ÄÂú∞‰∏§Ê£Ä.jpg" });
                    events.push({ tag: "Infra", date: "2018-10-24", title: "HZMB Official Opening", desc: "55km sea-crossing bridge opened, drastically cutting travel time to the West Pearl River Delta.", impact: "Pushed 2018 traffic to a record high (329.7M), integrating the West Bank into the 'One-Hour Living Circle'.", img: "2018Ê∏ØÁè†Êæ≥Â§ßÊ°•Ê≠£ÂºèÈÄöËΩ¶.jpg" });
                }
                if (year === "2019") events.push({ tag: "Society", date: "2019 H2", title: "Social Unrest Incidents", desc: "A series of social instability events occurred in Hong Kong.", impact: "Sea passenger numbers plunged 37.4%. HSR and Bridge traffic remained resilient due to closed-loop management.", img: "2019Á§æ‰ºöÈ£éÊ≥¢ (‚Äú‰øÆ‰æãÈ£éÊ≥¢‚Äù).jpg" });
                if (year === "2020") {
                    events.push({ tag: "Pandemic", date: "2020-02-04", title: "Full Border Closure (COVID-19)", desc: "Passenger services suspended at Lo Wu, Lok Ma Chau, etc. Only Airport and Shenzhen Bay remained partially open.", impact: "Cross-border flow dropped to near zero. 2020 traffic plunged 90.1% vs 2019, forming a historic 'Data Canyon'.", img: "2020ÂÖ®Èù¢Â∞ÅÂÖ≥ (COVID-19).jpg" });
                    events.push({ tag: "Logistics", date: "2020-08-26", title: "Heung Yuen Wai Port (Cargo)", desc: "Opened for cargo first. Implemented 'East-in East-out' strategy to divert truck traffic.", impact: "Reshaped logistics. Shenzhen Bay cargo surged 125.7%, securing material supplies during the pandemic.", img: "2020È¶ôÂõ≠Âõ¥.jpg" });
                }
                if (year === "2021" || year === "2022") events.push({ tag: "Tech", date: "Late 2021", title: "Contactless e-Channel Rollout", desc: "New clearance system with facial recognition for 'touch-free' passage.", impact: "Reduced clearance time to 7 seconds, preparing technical capacity for the eventual post-pandemic rebound.", img: "2021ÈùûËß¶Âºèe-ÈÅìÂÖ®Èù¢Êé®Âπø.jpeg" });
                if (year === "2023") {
                    events.push({ tag: "Recovery", date: "2023-02-06", title: "Full Resumption of Travel", desc: "All ports reopened without quotas. Heung Yuen Wai opened for passengers (first with direct parking).", impact: "Data showed a vertical 'V-shaped' rebound. Heung Yuen Wai became an instant hit for drivers/cyclists.", img: "2023ÂÖ®Èù¢ÊÅ¢Â§çÊ≠£Â∏∏ÈÄöÂÖ≥.jpg" });
                    events.push({ tag: "Policy", date: "2023-07-01", title: "'Northbound Travel for HK Vehicles'", desc: "Allowed eligible HK private cars to enter Guangdong via HZMB without dual plates.", impact: "Shifted travel mode from 'Public Transport Dominant' to 'Private Driving', boosting HZMB traffic.", img: "2023‚ÄúÊ∏ØËΩ¶Âåó‰∏ä‚ÄùÊîøÁ≠ñÂÆûÊñΩ.jpg" });
                    events.push({ tag: "Service", date: "2023-08-14", title: "HSR 'Flexi-trip' (Futian)", desc: "Free ticket changes up to 3 times for West Kowloon-Futian, even 1 hour after departure.", impact: "Operationalized HSR like a metro system, boosting short-haul traffic and changing rigid ticketing habits.", img: "2023È´òÈìÅ‚ÄúÁÅµÊ¥ªË°å‚Äù (Á¶èÁî∞ÊÆµ).jpg" });
                }
                if (year === "2024") {
                    events.push({ tag: "Policy", date: "2024-03-18", title: "'Flexi-trip' to Shenzhen North", desc: "Flexible ticket changes extended to Shenzhen North Station, connecting deeper into residential zones.", impact: " fueled 'Cross-border Commuting', supporting the 'Living in Shenzhen, Working in HK' lifestyle.", img: "2024Âª∂ÈïøÈÄöÂÖ≥ÊúçÂä°Êó∂Èó¥.jpg" });
                    events.push({ tag: "Service", date: "2024 Holidays", title: "Extended Clearance Hours", desc: "Shenzhen Bay 24h clearance; Lo Wu extended to 2am during major holidays.", impact: "Facilitated 'Northbound Nightlife'. 2024 saw a structural reversal: HK northbound traffic exceeded southbound.", img: "2024‚ÄúÁÅµÊ¥ªË°å‚ÄùÂª∂‰º∏Ëá≥Ê∑±Âú≥ÂåóÁ´ô.jpg" });
                }
                if (year === "2025") {
                    events.push({ tag: "Integration", date: "2025-10-13", title: "Closed Road Permit (CRP) Waived", desc: "Approved 'Northbound' vehicles no longer need CRP or fees, cutting red tape.", impact: "Cross-border driving became as simple as local driving, balancing bi-directional flows.", img: "2025ÂÖçÈô§Â∞ÅÈó≠ÈÅìË∑ØÈÄöË°åËÆ∏ÂèØËØÅ (CRP).jpg" });
                    events.push({ tag: "Future", date: "2026-01 (Announced)", title: "e-Channel Age Lowered to 7", desc: "Children aged 7+ allowed to use automated gates (expected Jan 2026).", impact: "Resolves family queuing bottlenecks, boosting efficiency for family tourism.", img: "2025e-ÈÅìÈÄÇÁî®Âπ¥ÈæÑÈôçËá≥7Â≤Å.jpg" });
                }
                db[year] = { stats: { total: (yData.total / 100000000).toFixed(2), daily: (yData.total / 365 / 10000).toFixed(1), unit: "Billion" }, ports: portStats, events: events };
            });

            let currentIndex = 0;
            let selectedPort = null;
            let map; 
            let g; 
            const initialCenter = [22.36, 114.05]; // Optimized view to include HZMB and Liantang
            const initialZoom = 10.5; // Optimized zoom
            const colorScale = d3.scaleOrdinal().domain(["railway", "hsr", "road", "water", "new", "air"]).range(["#2563EB", "#E11D48", "#059669", "#0284C7", "#D97706", "#7C3AED"]);
            const typeIcons = { "railway": "fa-subway", "hsr": "fa-train", "road": "fa-bus", "water": "fa-ship", "new": "fa-car", "air": "fa-plane" };
            const radiusScale = d3.scaleSqrt().domain([0, 30]).range([3, 40]);

            function initMap1() {
                if (document.getElementById('map1').innerHTML !== "") return;
                map = L.map('map1', { zoomControl: false, attributionControl: false, zoomSnap: 0.1 }).setView(initialCenter, initialZoom);
                window.map1Instance = map; // Store globally for resize
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
                L.control.zoom({ position: 'topright' }).addTo(map);
                L.svg({clickable: true}).addTo(map);
                const overlay = d3.select(map.getPanes().overlayPane).select("svg");
                const defs = overlay.append("defs");
                const types = ["railway", "hsr", "road", "water", "new", "air"];
                types.forEach(t => {
                    const baseColor = d3.color(colorScale(t));
                    const lighterColor = baseColor.brighter(0.8);
                    const gradient = defs.append("linearGradient").attr("id", `grad-pin-${t}`).attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "100%");
                    gradient.append("stop").attr("offset", "0%").attr("stop-color", lighterColor);
                    gradient.append("stop").attr("offset", "100%").attr("stop-color", baseColor);
                });
                g = overlay.select("g").attr("class", "leaflet-zoom-hide");
                map.on("zoomend", updatePositions);
                map.on("moveend", updatePositions);
                Object.keys(ports).forEach(pid => {
                    const p = ports[pid];
                    const icon = L.divIcon({ className: 'map-label-container', html: `<div class="map-label" onclick="window.selectPort1('${pid}')">${p.name}</div>`, iconSize: [160, 20], iconAnchor: [80, -15] });
                    L.marker([p.lat, p.lon], { icon: icon, zIndexOffset: -100 }).addTo(map);
                });
                updateYear(0);
            }

            function projectPoint(lat, lon) { const point = map.latLngToLayerPoint(new L.LatLng(lat, lon)); return [point.x, point.y]; }
            function updateYear(index) {
                currentIndex = index;
                const yearKey = timeLabels[index];
                document.getElementById('year-display').innerText = yearKey;
                const subTitleEl = document.getElementById('year-subtitle');
                if(subTitleEl) {
                    subTitleEl.style.opacity = 0;
                    setTimeout(() => { subTitleEl.innerText = yearSubtitles[yearKey] || "Checkpoint Flow Visualization"; subTitleEl.style.opacity = 1; }, 200);
                }
                if (selectedPort) renderPortDetail(selectedPort, yearKey); else renderOverview(yearKey);
                renderMapNodes(yearKey);
            }

            function renderMapNodes(yearKey) {
                const yearData = db[yearKey];
                if(!yearData) return;
                const portData = yearData.ports || {};
                const nodeData = Object.keys(ports).map(pid => { const staticInfo = ports[pid]; const dynamicInfo = portData[pid] || { daily10k: 0 }; return { id: pid, ...staticInfo, ...dynamicInfo }; });
                const nodes = g.selectAll(".node-group").data(nodeData, d => d.id);
                const enter = nodes.enter().append("g").attr("class", "node-group").on("click", (e, d) => window.selectPort1(d.id)).on("mouseover", showTooltip).on("mouseout", hideTooltip);
                enter.append("circle").attr("class", "active-marker-highlight").attr("r", 30).attr("fill", "none").attr("stroke", "#000").attr("stroke-opacity", 0.1).attr("stroke-width", 1).style("display", "none"); 
                enter.append("circle").attr("class", "data-circle").attr("fill-opacity", 0.2).attr("stroke-opacity", 0.6).attr("stroke-width", 1);
                enter.append("circle").attr("class", "pin-head pin-shadow").attr("r", 9).attr("cy", -14).attr("fill", d => `url(#grad-pin-${d.type})`).attr("stroke", "#fff").attr("stroke-width", 1.5);
                enter.append("foreignObject").attr("x", -8).attr("y", -22).attr("width", 16).attr("height", 16).style("pointer-events", "none").append("xhtml:div").style("width", "100%").style("height", "100%").style("display", "flex").style("align-items", "center").style("justify-content", "center").html(d => `<i class="fa-solid ${typeIcons[d.type]}" style="color:white; font-size:9px;"></i>`);
                enter.append("path").attr("class", "pin-needle").attr("d", "M -1 -5 L 0 0 L 1 -5 Z").attr("fill", "#555").attr("stroke", "none");
                const update = enter.merge(nodes);
                update.select(".data-circle").attr("r", d => Math.max(0, radiusScale(d.daily10k))).attr("fill", d => colorScale(d.type)).attr("stroke", d => colorScale(d.type));
                update.select(".pin-head").attr("fill", d => `url(#grad-pin-${d.type})`);
                update.select("foreignObject i").attr("class", d => `fa-solid ${typeIcons[d.type]}`);
                update.select(".active-marker-highlight").style("display", d => d.id === selectedPort ? "block" : "none").attr("stroke", d => colorScale(d.type));
                nodes.exit().remove();
                updatePositions();
            }

            function updatePositions() { g.selectAll(".node-group").attr("transform", d => { const p = projectPoint(d.lat, d.lon); return `translate(${p[0]},${p[1]})`; }); }

            function renderOverview(yearKey) {
                const data = db[yearKey];
                const panel = document.getElementById('info-panel');
                const backBtn = document.getElementById('back-btn');
                const selector = document.getElementById('port-selector');
                if (backBtn) backBtn.style.display = "none";
                if (selector) selector.value = "overview"; 
                const stats = data.stats;
                const eventsHtml = (data.events || []).map(e => `<div class="event-card"><div class="event-header"><span class="event-tag">${e.tag}</span><span class="event-date">${e.date}</span></div>${e.img ? `<img src="${e.img}" class="event-image" alt="${e.title}" onerror="this.src='https://placehold.co/600x400?text=No+Local+Image'">` : ''}<div class="event-title">${e.title}</div><div style="font-size:13px; color:#555; line-height:1.5;">${e.desc}</div>${e.impact ? `<div class="event-impact-box"><i class="fas fa-chart-line"></i> <strong>Impact:</strong> ${e.impact}</div>` : ''}</div>`).join('');
                
                // MODIFIED: Added .counter classes and data-target attributes
                panel.innerHTML = `<div class="stats-grid" style="margin-top:10px;"><div class="stat-item highlight"><label>Annual Total</label><div class="value"><span class="counter" data-target="${stats.total}" data-decimals="2">0.00</span> <span class="unit">Bn</span></div><span class="sub-value neutral">Total HK Cross-Border</span></div><div class="stat-item"><label>Daily Average</label><div class="value"><span class="counter" data-target="${stats.daily}" data-decimals="1">0.0</span> <span class="unit">k</span></div><span class="sub-value" style="color:#666">Sea/Land/Air</span></div></div><div class="event-section-title">Key Annual Events</div><div>${eventsHtml}</div><div style="margin-top:20px; font-size:11px; color:#94A3B8; text-align:center; padding:10px; border-top:1px dashed rgba(0,0,0,0.1);">Drag slider to change year ‚Ä¢ Click map pins for details</div>`;
                
                // TRIGGER ANIMATION
                triggerAnimations();
            }

            function renderPortDetail(pid, yearKey) {
                const pStatic = ports[pid];
                const yearData = db[yearKey];
                const pData = yearData.ports ? yearData.ports[pid] : null;
                const panel = document.getElementById('info-panel');
                const backBtn = document.getElementById('back-btn');
                const selector = document.getElementById('port-selector');
                if (backBtn) backBtn.style.display = "block";
                if (selector) selector.value = pid; 
                if (!pData || pData.annual === 0) {
                    panel.innerHTML = `<div class="card-header"><span class="card-title" style="color:${colorScale(pStatic.type)}">${pStatic.name}</span></div><div style="padding:40px; text-align:center; color:#999; border:2px dashed rgba(0,0,0,0.1); border-radius:12px;">No passenger traffic recorded.<br><span style="font-size:12px">(${yearKey})</span></div><div class="event-section-title" style="margin-top:20px">Annual Status</div><div class="narrative-box" style="border-left:4px solid ${colorScale(pStatic.type)};">${pData ? pData.desc : "No Data"}</div>`;
                    return;
                }
                let growthHtml = '';
                if(pData.growth === "New") growthHtml = `<span style="color:#D97706; font-weight:700;">‚ú® New</span>`;
                else if (pData.growth !== "N/A" && pData.growth !== "0") { const isPos = parseFloat(pData.growth) >= 0; const color = isPos ? '#059669' : '#DC2626'; const icon = isPos ? '‚Üë' : '‚Üì'; growthHtml = `<span style="color:${color}; font-weight:700;">${icon} ${Math.abs(pData.growth)}%</span> (YoY)`; } 
                else growthHtml = `<span style="color:#94A3B8;">-</span>`;
                
                // MODIFIED: Added .counter classes and data-target attributes
                const annualVal = (pData.annual/1000000).toFixed(2);
                const dailyVal = (pData.daily/1000).toFixed(1);
                
                panel.innerHTML = `<div class="card-header"><span class="card-title" style="color:${colorScale(pStatic.type)}">${pStatic.name}</span></div><img src="${pStatic.img}" class="port-detail-image" alt="${pStatic.name}" onerror="this.src='https://placehold.co/600x400?text=No+Image'"><div class="stats-grid three-cols"><div class="stat-item highlight"><label>Annual Total</label><div class="value" style="font-size:24px;"><span class="counter" data-target="${annualVal}" data-decimals="2">0.00</span><span style="font-size:12px">M</span></div><span class="sub-value" style="font-size:10px;">${growthHtml}</span></div><div class="stat-item"><label>Daily Avg</label><div class="value" style="font-size:24px;"><span class="counter" data-target="${dailyVal}" data-decimals="1">0.0</span><span style="font-size:12px">k</span></div><span class="sub-value" style="font-size:10px; color:#64748B;">pax/day</span></div><div class="stat-item"><label>HK Share</label><div class="value" style="font-size:24px;"><span class="counter" data-target="${pData.share}" data-decimals="1">0.0</span>%</div><div style="width:100%; height:4px; background:rgba(0,0,0,0.1); margin-top:4px; border-radius:2px;"><div style="width:${pData.share}%; height:100%; background:${colorScale(pStatic.type)}; border-radius:2px;"></div></div></div></div><div class="event-section-title">Annual Status Analysis</div><div class="narrative-box" style="border-left:4px solid ${colorScale(pStatic.type)};">${pData.desc}</div><div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.6); border-radius:6px; font-size:13px; color:#64748B; border:1px solid rgba(255,255,255,0.8);"><i class="fas fa-info-circle"></i> Status: <strong>${pData.status}</strong></div>`;
                
                // TRIGGER ANIMATION
                triggerAnimations();
            }

            const tooltip = document.getElementById('tooltip');
            function showTooltip(event, d) {
                if(d.daily10k === 0) return;
                const tagsHtml = d.tags.map(t => `<span class="t-tag">${t}</span>`).join('');
                tooltip.innerHTML = `<div class="tooltip-header" style="border-bottom-color:${colorScale(d.type)}; color:${colorScale(d.type)}">${d.name}</div><div class="tooltip-body"><div class="tooltip-meta"><div class="tooltip-stat"><span class="tooltip-stat-label">Daily Avg:</span>${(d.daily/10000).toFixed(2)} M</div></div><div class="tooltip-tags">${tagsHtml}</div><div class="tooltip-desc">${d.brief}</div></div>`;
                tooltip.style.opacity = 1;
                const tooltipWidth = tooltip.offsetWidth; const tooltipHeight = tooltip.offsetHeight;
                const xOffset = 20; const yOffset = 20;
                let left = event.pageX + xOffset; if (left + tooltipWidth > window.innerWidth) left = event.pageX - tooltipWidth - xOffset;
                let top = event.pageY - yOffset; if (top + tooltipHeight > window.innerHeight) top = event.pageY - tooltipHeight - yOffset;
                tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
            }
            function hideTooltip() { tooltip.style.opacity = 0; }
            window.selectPort1 = function(pid) { selectedPort = pid; updateYear(currentIndex); const p = ports[pid]; if(p) map.flyTo([p.lat, p.lon], 16, { duration: 1.5 }); }
            window.resetView = function() { selectedPort = null; updateYear(currentIndex); map.flyTo(initialCenter, initialZoom, { duration: 1.5 }); }

            // Init listeners
            document.addEventListener("DOMContentLoaded", function() { 
                initMap1(); 
                document.getElementById('year-slider').addEventListener('input', (e) => updateYear(parseInt(e.target.value)));
                document.getElementById('port-selector').addEventListener('change', (e) => { const val = e.target.value; if(val === 'overview') resetView(); else window.selectPort1(val); });
            });
        })();
    </script>

    <!-- PART 2 LOGIC (React) -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS DEFINITION ---
        const Icons = {
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Network: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Car: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>,
            Bike: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="15" cy="5" r="1"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/></svg>,
            Footprints: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8.75A8.6 8.6 0 0 1 4 4.5c2.41 0 2.5 1.5 4 1.5 2.08 0 3.5.75 3.5 3.5 0 2.14-1.69 3.5-3.5 3.5-1.41 0-2 .6-2 3Z"/><path d="M14 20v-2.38c0-2.12-1.03-3.12-1-4.87a8.6 8.6 0 0 1 1-4.25c2.41 0 2.5 1.5 4 1.5 2.08 0 3.5.75 3.5 3.5 0 2.14-1.69 3.5-3.5 3.5-1.41 0-2 .6-2 3Z"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Plane: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22h20"/><path d="M12 2L2 22"/><path d="M22 22L12 2"/><path d="M12 6l5 13"/><path d="M12 6l-5 13"/></svg>,
            Trestle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h20"/><path d="M3 12v6"/><path d="M21 12v6"/><path d="M6 12c0-3 3-5 6-5s6 2 6 5"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Bus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="17" cy="18" r="2"/></svg>,
            Train: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/></svg>,
            Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Filter: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            ArrowRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Landmark: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg>,
            Key: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const IconComponent = Icons[name];
            return IconComponent ? <IconComponent size={size} className={className} /> : null;
        };

        const ISO_COLORS = ['#d7191c', '#fdae61', '#ffffbf', '#a6d96a', '#1a9641'];
        const COLORS = { primary: '#0E7490', hsr: '#E11D48', bus_cross: '#D97706', drive: '#059669', metro: '#2563EB', mtr_eastrail: '#0284C7' };
        
        const SVG_ICONS = {
            bus: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="17" cy="18" r="2"/></svg>`,
            car: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
            train: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/></svg>`,
            plane: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22h20"/><path d="M12 2L2 22"/><path d="M22 22L12 2"/><path d="M12 6l5 13"/><path d="M12 6l-5 13"/></svg>`,
            circle: `<div style="background:white; width:10px; height:10px; border-radius:50%; border:3px solid currentColor;"></div>`
        };

        const getStationIconHtml = (type, color) => {
            let svg = SVG_ICONS.circle;
            if (type === 'bus') svg = SVG_ICONS.bus;
            else if (type === 'drive') svg = SVG_ICONS.car;
            else if (type === 'hsr' || type === 'metro' || type === 'hub') svg = SVG_ICONS.train;
            else if (type === 'air') svg = SVG_ICONS.plane;
            return `<div style="background:${color}; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.15);">${svg}</div>`;
        };
        
        const DEFAULT_KEY_INPUT = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjI0NmY0YzlhNjI5NzQyMjlhZGYzNmQyMDEyYzM2YmZiIiwiaCI6Im11cm11cjY0In0=";

        const YEAR_DATA = {
            2017: { title: "Institutional Friction", desc: "Customs clearance was an unpredictable variable, significantly inflating cross-border commute time costs.", event: "Manual clearance dominant; limited e-Channels.", commute: "90-120 mins (Volatile)", cost: "HKD 40‚Äì150" },
            2018: { title: "Breaking the Ice", desc: "HSR & HZMB openings marked a shift from 'crossing a border' to standardized transport procedures.", event: "XRL (HSR) & HZMB Opening", commute: "HSR ~60 mins (Predictable)", cost: "HSR ¬•75+" },
            2019: { title: "Reshaping Patterns", desc: "Shenzhen became a stable 1-hr core; Dongguan entered the range. Functional division of cities began.", event: "GBA Outline Plan / Liantang Port", commute: "HSR stable <60m; Cost divergence", cost: "Varies by mode" },
            2020: { title: "Physical Disruption", desc: "Pandemic controls suspended the functional 'living circle' despite the existence of physical links.", event: "COVID-19 border controls", commute: "Severely restricted / Unstable", cost: "N/A" },
            2021: { title: "Digital Preparation", desc: "Health code systems and digital declarations laid technical groundwork for future efficient clearance.", event: "Digital Declaration Trials", commute: "Low frequency, restricted", cost: "N/A" },
            2022: { title: "Network Optimization", desc: "MTR East Rail cross-harbour extension seamlessly linked HK Island to the border (Lo Wu/Lok Ma Chau).", event: "East Rail Cross-Harbour Ext.", commute: "East Rail direct to Island (~50m)", cost: "HKD 50-60" },
            2023: { title: "Full Recovery", desc: "Normalization made the 1-hour living circle routine rather than just technically feasible.", event: "Full Reopening / Northbound Travel", commute: "Returned to normal", cost: "Returned to normal" },
            2024: { title: "Corridor Breakthrough", desc: "Shenzhen-Zhongshan Link opened, expanding the living circle to the West Bank (Zhongshan/Zhuhai).", event: "Shenzhen-Zhongshan Link Opens", commute: "SZ-Zhongshan ~30 mins", cost: "Bus ~¬•50-80" },
            2025: { title: "Network Maturity", desc: "The 1-hour circle solidified into a tiered network based on functional division under time constraints.", event: "Multi-modal network maturity", commute: "Stable, high coverage", cost: "Diversified options" }
        };

        const REAL_PATHS = {
            'bus-pe-szb': [[22.3245, 114.1685], [22.3200, 114.1600], [22.3150, 114.1550], [22.3400, 114.1200], [22.3650, 114.1000], [22.3780, 114.0500], [22.3800, 114.0000], [22.3900, 113.9750], [22.4200, 113.9800], [22.4600, 113.9900], [22.4800, 113.9600], [22.4900, 113.9500], [22.5039, 113.9447]],
            'bus-wc-hg': [[22.2816, 114.1753], [22.2850, 114.1800], [22.2920, 114.1750], [22.3000, 114.1700], [22.3100, 114.1750], [22.3400, 114.1800], [22.3700, 114.1780], [22.4200, 114.1600], [22.4800, 114.1200], [22.5050, 114.0800], [22.5207, 114.0749]],
            'bus-hzmb': [[22.3171, 113.9544], [22.3050, 113.9350], [22.2900, 113.9100], [22.2850, 113.8800], [22.2800, 113.8000], [22.2700, 113.7000], [22.2200, 113.6000], [22.2084, 113.5764]],
            'bus-sz-zhong': [[22.5404, 114.0538], [22.5400, 113.9500], [22.5600, 113.8800], [22.5800, 113.8400], [22.5850, 113.8000], [22.5800, 113.7600], [22.5700, 113.7000], [22.5600, 113.6500], [22.5500, 113.6000], [22.5255, 113.3820]],
            'drive-sz-hk': [[22.2819, 114.1589], [22.2900, 114.1500], [22.3050, 114.1550], [22.3300, 114.1500], [22.3600, 114.1400], [22.4200, 114.0800], [22.4800, 114.0600], [22.5207, 114.0749]],
            'drive-hzmb-private': [[22.3171, 113.9544], [22.3050, 113.9350], [22.2900, 113.9100], [22.2850, 113.8800], [22.2800, 113.8000], [22.2700, 113.7000], [22.2200, 113.6000], [22.2084, 113.5764]],
            'drive-sz-zhong-private': [[22.5404, 114.0538], [22.5600, 113.8800], [22.5800, 113.8400], [22.5850, 113.8000], [22.5800, 113.7600], [22.5700, 113.7000], [22.5600, 113.6500], [22.5500, 113.6000], [22.5255, 113.3820]],
            'mtr-east-sz': [
                { coords: [[22.2794, 114.1646], [22.2810, 114.1750], [22.3033, 114.1814]], color: '#38BDF8', startYear: 2022 },
                { coords: [[22.3033, 114.1814], [22.3220, 114.1720], [22.3370, 114.1760], [22.3735, 114.1785], [22.3830, 114.1870], [22.4130, 114.2100], [22.4460, 114.1700], [22.4920, 114.1400], [22.5010, 114.1280]], color: COLORS.mtr_eastrail, startYear: 2017 },
                { coords: [[22.5010, 114.1280], [22.5282, 114.1134]], color: COLORS.mtr_eastrail, startYear: 2017 },
                { coords: [[22.5010, 114.1280], [22.5050, 114.1000], [22.5100, 114.0800], [22.5150, 114.0660]], color: '#60A5FA', startYear: 2017 },
                { coords: [[22.5282, 114.1134], [22.5350, 114.1100], [22.5440, 114.0550]], color: '#10B981', startYear: 2017 },
                { coords: [[22.5150, 114.0660], [22.5250, 114.0600], [22.5440, 114.0550]], color: '#EF4444', startYear: 2017 }
            ],
            'hsr-main': [[22.3029, 114.1648], [22.3500, 114.1500], [22.4500, 114.0800], [22.5100, 114.0600], [22.5383, 114.0566], [22.5800, 114.0300], [22.6152, 114.0276], [22.7500, 113.9500], [22.8500, 113.6000], [22.9000, 113.4000], [22.9875, 113.2686]]
        };

        const ROUTE_CONFIG = {
            'bus-pe-szb': { name: "Bus: Prince Edward ‚áÑ Shenzhen Bay", type: 'bus', color: COLORS.bus_cross, startYear: 2017, desc: "The classic cross-border workhorse.", experience: "A reliable but often crowded route. Popular with commuters living in Western Shenzhen.", time: "70-90 mins", cost: "HKD 50-60", stations: [{name:"Prince Edward", coords:[22.3245, 114.1685]}, {name:"Shenzhen Bay", coords:[22.5039, 113.9447]}] },
            'bus-wc-hg': { name: "Bus: Wan Chai ‚áÑ Huanggang (24h)", type: 'bus', color: COLORS.bus_cross, startYear: 2017, desc: "The sleepless connector for business travelers.", experience: "Essential for night owls and business travelers needing flexibility.", time: "60-80 mins", cost: "HKD 57", stations: [{name:"Wan Chai", coords:[22.2816, 114.1753]}, {name:"Huanggang", coords:[22.5207, 114.0749]}] },
            'bus-hzmb': { name: "Bus: HZMB Shuttle (HK ‚áÑ Zhuhai)", type: 'bus', color: COLORS.bus_cross, startYear: 2018, desc: "The 'Gold Bus' scenic ocean journey.", experience: "A visually stunning journey across the sea. The bridge engineering is a marvel.", time: "40 mins (Port-to-Port)", cost: "HKD 65", stations: [{name:"HK Port", coords:[22.3171, 113.9544]}, {name:"Zhuhai Port", coords:[22.2084, 113.5764]}] },
            'bus-sz-zhong': { name: "Bus: Shen-Zhong Express (SZ ‚áÑ ZS)", type: 'bus', color: COLORS.bus_cross, startYear: 2024, desc: "The 30-minute cross-estuary shortcut.", experience: "A game changer that replaced the ferry for many. Slashes travel time from 2 hours to 30 mins.", time: "30-45 mins", cost: "CNY 18-28", stations: [{name:"Shenzhen Futian", coords:[22.5404, 114.0538]}, {name:"Zhongshan", coords:[22.5255, 113.3820]}] },
            'drive-sz-hk': { name: "Drive: Dual Plate (HK ‚áÑ SZ)", type: 'drive', color: COLORS.drive, startYear: 2017, desc: "Traditional point-to-point luxury.", experience: "The ultimate convenience of driving door-to-door, but requires expensive dual license plates.", time: "60-90 mins", cost: "Fuel + Tolls", stations: [{name:"HK Central", coords:[22.2819, 114.1589]}, {name:"Shenzhen Huanggang", coords:[22.5207, 114.0749]}] },
            'drive-hzmb-private': { name: "Drive: HZMB (Northbound Travel)", type: 'drive', color: COLORS.drive, startYear: 2018, desc: "Self-driving lifestyle revolution.", experience: "Allows HK private cars to drive to Zhuhai/Guangdong for weekends.", time: "30-40 mins", cost: "Toll CNY 150", stations: [{name:"HK Port", coords:[22.3171, 113.9544]}, {name:"Zhuhai Port", coords:[22.2084, 113.5764]}] },
            'drive-sz-zhong-private': { name: "Drive: Shen-Zhong Link (SZN ‚áÑ ZS)", type: 'drive', color: COLORS.drive, startYear: 2024, desc: "Runway on the sea to the West Bank.", experience: "Connects Shenzhen's high-tech Qianhai hub to Zhongshan's affordable living.", time: "30 mins", cost: "CNY 66", stations: [{name:"Shenzhen Qianhai", coords:[22.5404, 114.0538]}, {name:"Zhongshan Cuiheng", coords:[22.5255, 113.3820]}] },
            'mtr-east-sz': { 
                name: "Metro: East Rail + SZ Metro", type: 'metro', color: COLORS.metro, startYear: 2017, desc: "The reliable backbone of integration.", experience: "With the Cross-Harbour extension, you can travel from HK Island financial district directly to the Shenzhen border.", time: "~60-70 mins", cost: "HKD 50 + CNY 5", 
                stations: [
                    { name: "Admiralty", coords: [22.2794, 114.1646], type: "terminus", startYear: 2022 }, { name: "Exhibition Centre", coords: [22.2810, 114.1750], startYear: 2022 },
                    { name: "Hung Hom", coords: [22.3033, 114.1814] }, { name: "Mong Kok East", coords: [22.3220, 114.1720] }, { name: "Kowloon Tong", coords: [22.3370, 114.1760] }, { name: "Tai Wai", coords: [22.3735, 114.1785] }, 
                    { name: "Sha Tin", coords: [22.3830, 114.1870] }, { name: "University", coords: [22.4130, 114.2100] }, { name: "Tai Po Market", coords: [22.4460, 114.1700] }, { name: "Fanling", coords: [22.4920, 114.1400] }, 
                    { name: "Sheung Shui", coords: [22.5010, 114.1280] }, { name: "Lo Wu", coords: [22.5282, 114.1134], type: "border" }, { name: "Lok Ma Chau", coords: [22.5150, 114.0660], type: "border" },
                    { name: "Civic Center", coords: [22.5440, 114.0550], type: "terminus" }
                ] 
            },
            'hsr-main': { 
                name: "HSR: High Speed Rail (XRL)", type: 'hsr', color: COLORS.hsr, startYear: 2018, desc: "Premium speed and city-center access.", experience: "14 minutes to Futian is faster than most domestic commutes.", time: "14-48 mins", cost: "¬•68+", 
                stations: [ { name: "HK West Kowloon", coords: [22.302967, 114.164853], type: "terminus" }, { name: "Futian", coords: [22.538333, 114.056667] }, { name: "Shenzhen North", coords: [22.615228, 114.027602], type: "hub" }, { name: "Guangzhou South", coords: [22.987500, 113.268611], type: "terminus" } ] 
            }
        };

        const TRANSPORT_MODES = [
            { id: 'driving', label: 'Driving', icon: 'Car', subOptions: [{ id: 'driving-car', name: 'Private Car', apiProfile: 'driving-car' }, { id: 'driving-hgv', name: 'HGV', apiProfile: 'driving-hgv' }] },
            { id: 'cycling', label: 'Cycling', icon: 'Bike', subOptions: [{ id: 'cycling-regular', name: 'Regular Cycling', apiProfile: 'cycling-regular' }, { id: 'cycling-road', name: 'Road Bike', apiProfile: 'cycling-road' }] },
            { id: 'walking', label: 'Walking', icon: 'Footprints', subOptions: [{ id: 'foot-walking', name: 'Walking', apiProfile: 'foot-walking' }, { id: 'foot-hiking', name: 'Hiking', apiProfile: 'foot-hiking' }] }
        ];

        const INFRASTRUCTURE_DATA = {
            airports: [ { name: "HK Int'l Airport", coords: [22.3080, 113.9185] }, { name: "SZ Bao'an Airport", coords: [22.6394, 113.8108] }, { name: "GZ Baiyun Airport", coords: [23.3925, 113.2988] }, { name: "Macau Int'l Airport", coords: [22.1583, 113.5938] } ],
            bridges: [ 
                { name: "HZMB", coords: [[22.3171, 113.9544], [22.3050, 113.9350], [22.2900, 113.9100], [22.2850, 113.8800], [22.2800, 113.8000], [22.2700, 113.7000], [22.2200, 113.6000], [22.2084, 113.5764]], name: "HZMB" }, 
                { name: "Shen-Zhong Link", coords: [[22.5600, 113.8800], [22.5800, 113.8400], [22.5850, 113.8000], [22.5800, 113.7600], [22.5700, 113.7000], [22.5600, 113.6500], [22.5500, 113.6000]], name: "Shen-Zhong Link" },
                { name: "Nansha Bridge", coords: [[22.8800, 113.5600], [22.8750, 113.5500], [22.8700, 113.5400]], name: "Nansha Bridge" } 
            ],
            hubs: [ { name: "HK West Kowloon", coords: [22.3029, 114.1648] }, { name: "Shenzhen North", coords: [22.6115, 114.0298] }, { name: "Guangzhou South", coords: [22.9875, 113.2686] } ],
            borders: [ { name: "Lo Wu Port", coords: [22.5282, 114.1134] }, { name: "Futian / Lok Ma Chau", coords: [22.5183, 114.0667] }, { name: "Shenzhen Bay Port", coords: [22.5039, 113.9447] }, { name: "HZMB Port", coords: [22.3171, 113.9544] }, { name: "Liantang / Heung Yuen Wai", coords: [22.5539, 114.1481] } ]
        };

        const PRESETS = [
            { name: "HK West Kowloon", coords: [22.3029, 114.1648] },
            { name: "Shenzhen Futian", coords: [22.5383, 114.0566] },
            { name: "Zhuhai Gongbei", coords: [22.2158, 113.5555] },
            { name: "Guangzhou South", coords: [22.9875, 113.2686] }
        ];

        function App() {
            const [viewMode, setViewMode] = useState('history'); 
            const [position, setPosition] = useState([22.3029, 114.1648]);
            const [addressLabel, setAddressLabel] = useState("HK West Kowloon");
            const [transportMode, setTransportMode] = useState('driving');
            const [subProfile, setSubProfile] = useState('driving-car');
            const [rangeType, setRangeType] = useState('time'); 
            const [rangeMax, setRangeMax] = useState(30); 
            const [rangeInterval, setRangeInterval] = useState(10); 
            const [apiKey, setApiKey] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const [isoData, setIsoData] = useState(null);
            const [year, setYear] = useState(2025);
            const [historyFilter, setHistoryFilter] = useState('all');
            const [selectedRouteId, setSelectedRouteId] = useState(null);
            const [infraFilter, setInfraFilter] = useState({ air: true, bridge: true, hub: true, border: true });
            const [showSearch, setShowSearch] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [replayCount, setReplayCount] = useState(0);

            const mapRef = useRef(null);
            const mainLayerRef = useRef(null);
            const connectivityLayerRef = useRef(null);
            const markerRef = useRef(null);
            const prevPropsRef = useRef({ viewMode: 'history', year: 2025, historyFilter: 'all', selectedRouteId: null });
            const activeStationsRef = useRef([]);
            const timeoutsRef = useRef([]);

            useEffect(() => {
                const processKey = (inputKey) => {
                    try {
                        if (!inputKey.includes("eyJ")) return inputKey; 
                        const decoded = atob(inputKey);
                        const parsed = JSON.parse(decoded);
                        return parsed.org || inputKey;
                    } catch (e) { return inputKey; }
                };
                setApiKey(processKey(DEFAULT_KEY_INPUT));
            }, []);

            useEffect(() => {
                if (mapRef.current) return;
                
                // Initialize map container for Part 2
                // Ensure the container exists before appending
                const parent = document.getElementById('view-part2');
                if(!parent) return;

                // Cleanup existing if any
                if(document.getElementById('map-part2-inner')) {
                    document.getElementById('map-part2-inner').remove();
                }

                const container = L.DomUtil.create('div', 'full-screen-map');
                container.id = 'map-part2-inner';
                parent.appendChild(container); // Append to Part 2 view

                const map = L.map(container, { zoomControl: false, zoomSnap: 0.1, attributionControl: false }).setView(position, 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
                L.control.zoom({ position: 'topright' }).addTo(map);
                mapRef.current = map;
                mainLayerRef.current = L.layerGroup().addTo(map);
                connectivityLayerRef.current = L.layerGroup().addTo(map);
                map.on('click', (e) => {
                    const { lat, lng } = e.latlng;
                    if (viewMode === 'isochrone') updatePosition([lat, lng], `${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                });
                renderConnectivity();
                
                // Handle resize
                const resizeObserver = new ResizeObserver(() => {
                    map.invalidateSize();
                });
                resizeObserver.observe(container);

                // Add window listener to resize map when tab changes
                window.addEventListener('resize', () => {
                   map.invalidateSize(); 
                });
            }, []);

            useEffect(() => {
                 if (viewMode === 'isochrone') {
                     updatePosition(position, addressLabel);
                 } else if (markerRef.current) {
                     if (mapRef.current) {
                         mapRef.current.removeLayer(markerRef.current);
                         markerRef.current = null;
                     }
                 }
            }, [viewMode]);

            const updatePosition = (coords, label) => {
                setPosition(coords);
                setAddressLabel(label);
                if (mapRef.current) {
                    if (markerRef.current) mapRef.current.removeLayer(markerRef.current);
                    const icon = L.divIcon({ className: 'custom-pin', html: `<div style="background-color: #0E7490; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>`, iconSize: [16, 16], iconAnchor: [8, 8] });
                    markerRef.current = L.marker(coords, { icon }).addTo(mapRef.current);
                }
            };

            const calculateStationDelay = (stationCoords, pathCoords, durationSeconds) => {
                if (!pathCoords || pathCoords.length === 0) return 0;
                let minDist = Infinity;
                let closestIndex = 0;
                for(let i=0; i<pathCoords.length; i++) {
                    const d = Math.pow(pathCoords[i][0]-stationCoords[0], 2) + Math.pow(pathCoords[i][1]-stationCoords[1], 2);
                    if(d < minDist) {
                        minDist = d;
                        closestIndex = i;
                    }
                }
                return (closestIndex / pathCoords.length) * durationSeconds * 1000;
            };

            const animatePath = (polyline, durationSeconds, originalDashArray = null) => {
                setTimeout(() => {
                    const path = polyline.getElement();
                    if (!path) return;
                    const length = path.getTotalLength();
                    if (!length) return;

                    path.style.transition = 'none';
                    path.style.strokeDasharray = `${length} ${length}`;
                    path.style.strokeDashoffset = length;
                    path.getBoundingClientRect();
                    requestAnimationFrame(() => {
                        path.style.transition = `stroke-dashoffset ${durationSeconds}s linear`;
                        path.style.strokeDashoffset = '0';
                    });

                    const cleanup = () => {
                        if (!path) return;
                        path.style.transition = 'none';
                        if (originalDashArray) { path.style.strokeDasharray = originalDashArray; } 
                        else { path.style.strokeDasharray = ''; path.style.strokeDashoffset = ''; }
                    };
                    const timer = setTimeout(cleanup, durationSeconds * 1000);
                    timeoutsRef.current.push(timer);
                    
                    const map = polyline._map;
                    if (map) {
                        const onZoom = () => { clearTimeout(timer); cleanup(); map.off('zoomstart', onZoom); };
                        map.once('zoomstart', onZoom);
                    }
                }, 50);
            };

            const drawStaticRoute = (pathCoords, color, name, routeId, stations = [], fitBounds = true, speed = 5.0, type = 'bus') => {
                const L = window.L;
                if (!mapRef.current || !mainLayerRef.current || !pathCoords) return [];
                const polyline = L.polyline(pathCoords, { color, weight: 4, opacity: 0.8, lineCap: 'round', smoothFactor: 2 }).addTo(mainLayerRef.current);
                animatePath(polyline, speed);
                polyline.on('click', () => {
                    if(selectedRouteId === routeId) {
                        setSelectedRouteId(null);
                    } else {
                        setSelectedRouteId(routeId);
                        setReplayCount(c => c+1);
                    }
                });
                
                const renderedStations = [];
                stations.forEach((station, idx) => {
                    if (station.startYear && station.startYear > year) return;
                    const delay = calculateStationDelay(station.coords, pathCoords, speed);
                    const isStart = idx === 0;
                    const isEnd = idx === stations.length - 1;
                    if (isStart || isEnd || type === 'metro' || type === 'hsr') {
                        const iconHtml = getStationIconHtml(type, isStart ? '#059669' : (isEnd ? '#E11D48' : color));
                        const icon = L.divIcon({ className: 'station-node', html: iconHtml, iconSize: [22, 22] });
                        const m = L.marker(station.coords, {icon}).addTo(mainLayerRef.current);
                        if(m._icon) m._icon.style.opacity = '0';
                        if(m._shadow) m._shadow.style.opacity = '0';
                        const revealTimer = setTimeout(() => {
                            if (m && m._icon) {
                                m._icon.style.opacity = '1';
                                m._icon.classList.add('station-btn-effect');
                            }
                        }, delay);
                        timeoutsRef.current.push(revealTimer);
                        m.bindTooltip(station.name, { permanent: true, direction: 'top', offset: [0, -10], className: 'map-label' });
                        const tooltipTimer = setTimeout(() => {
                            if (m && m.getTooltip() && m.getTooltip()._container) {
                                m.getTooltip()._container.classList.add('visible');
                            }
                        }, delay);
                        timeoutsRef.current.push(tooltipTimer);
                        renderedStations.push(station.coords);
                    }
                });
                return renderedStations;
            };

            const drawStaticRail = (data, routeId, fitBounds = true, speed = 3.0, currentYear) => {
                const L = window.L;
                if (!mapRef.current || !mainLayerRef.current) return [];
                const routePaths = REAL_PATHS[routeId];
                // FIX: Added strict Array check
                if (!routePaths || !Array.isArray(routePaths) || routePaths.length === 0) return [];
                const isMultiSegment = !Array.isArray(routePaths[0]);
                const allPolylines = [];
                let flattenedPath = []; 
                if (isMultiSegment) {
                    routePaths.forEach(segment => {
                        if (segment.startYear && segment.startYear > currentYear) return;
                        const polyline = L.polyline(segment.coords, { color: segment.color || data.color, weight: 4, opacity: 0.9, lineCap: 'round', dashArray: '10, 5', smoothFactor: 2 }).addTo(mainLayerRef.current);
                        animatePath(polyline, speed, '10, 5');
                        polyline.on('click', () => {
                           if(selectedRouteId === routeId) setSelectedRouteId(null);
                           else { setSelectedRouteId(routeId); setReplayCount(c => c+1); }
                        });
                        allPolylines.push(polyline);
                        flattenedPath = [...flattenedPath, ...segment.coords];
                    });
                } else {
                    const polyline = L.polyline(routePaths, { color: data.color, weight: 4, opacity: 0.9, lineCap: 'round', dashArray: '10, 5', smoothFactor: 2 }).addTo(mainLayerRef.current);
                    animatePath(polyline, speed, '10, 5');
                    polyline.on('click', () => {
                        if(selectedRouteId === routeId) setSelectedRouteId(null);
                        else { setSelectedRouteId(routeId); setReplayCount(c => c+1); }
                    });
                    allPolylines.push(polyline);
                    flattenedPath = routePaths;
                }

                const renderedStations = [];
                data.stations.forEach((station, idx) => {
                    if (station.startYear && station.startYear > currentYear) return;
                    const delay = calculateStationDelay(station.coords, flattenedPath, speed);
                    const stationColor = data.color;
                    const stationIconHtml = getStationIconHtml(data.type, stationColor);
                    const stationIcon = L.divIcon({ className: 'station-node', html: stationIconHtml, iconSize: [22, 22] });
                    const m = L.marker(station.coords, { icon: stationIcon }).addTo(mainLayerRef.current);
                    if(m._icon) m._icon.style.opacity = '0';
                    const revealTimer = setTimeout(() => {
                        if (m && m._icon) {
                            m._icon.style.opacity = '1';
                            m._icon.classList.add('station-btn-effect');
                        }
                    }, delay);
                    timeoutsRef.current.push(revealTimer);
                    m.bindTooltip(station.name, { permanent: true, direction: 'top', offset: [0, -8], className: 'map-label' });
                    const tooltipTimer = setTimeout(() => {
                         if (m && m.getTooltip() && m.getTooltip()._container) {
                             m.getTooltip()._container.classList.add('visible');
                         }
                    }, delay);
                    timeoutsRef.current.push(tooltipTimer);
                    renderedStations.push(station.coords);
                });
                return renderedStations;
            };

            const getSpeedByType = (type) => {
                if (type === 'hsr') return 3.0; 
                if (type === 'metro') return 3.5;
                return 5.0; 
            };

            const renderHistoryLayers = (shouldFit = true) => {
                if (!mainLayerRef.current) return [];
                timeoutsRef.current.forEach(clearTimeout);
                timeoutsRef.current = [];
                let allStations = [];
                if (selectedRouteId && ROUTE_CONFIG[selectedRouteId]) {
                    const config = ROUTE_CONFIG[selectedRouteId];
                    if (!REAL_PATHS[selectedRouteId]) return [];
                    const speed = getSpeedByType(config.type);
                    const stations = (config.type === 'bus' || config.type === 'drive')
                            ? drawStaticRoute(REAL_PATHS[selectedRouteId], config.color, config.name, selectedRouteId, config.stations, true, speed, config.type)
                            : drawStaticRail(config, selectedRouteId, true, speed, year);
                    allStations = [...stations];
                    const layerGroup = new L.FeatureGroup(mainLayerRef.current.getLayers().filter(l => l instanceof L.Polyline));
                    if (layerGroup.getLayers().length > 0 && mapRef.current) { mapRef.current.fitBounds(layerGroup.getBounds(), { padding: [100, 100] }); }
                    return allStations;
                }
                const validRoutes = Object.entries(ROUTE_CONFIG)
                    .filter(([_, config]) => config.startYear <= year)
                    .map(([id, config]) => ({ id, ...config }));
                const routesToDraw = historyFilter === 'all' ? validRoutes : validRoutes.filter(r => r.type === historyFilter);
                const allBounds = window.L.latLngBounds([]);
                routesToDraw.forEach(route => {
                    const speed = getSpeedByType(route.type);
                    if (!REAL_PATHS[route.id]) return;
                    let stations = [];
                    if (route.type === 'bus' || route.type === 'drive') {
                        stations = drawStaticRoute(REAL_PATHS[route.id], route.color, route.name, route.id, route.stations, false, speed, route.type);
                    } else {
                        stations = drawStaticRail(route, route.id, false, speed, year);
                    }
                    allStations = [...allStations, ...stations];
                    if (stations.length > 0) allBounds.extend(stations);
                });
                const layerGroup = new L.FeatureGroup(mainLayerRef.current.getLayers());
                if (shouldFit && layerGroup.getLayers().length > 0 && mapRef.current) { mapRef.current.fitBounds(layerGroup.getBounds(), { padding: [50, 50] }); }
                return allStations;
            };

            const fetchIsochrones = async () => {
                if (!apiKey) { setErrorMsg("API Key missing"); return; }
                setIsLoading(true); setErrorMsg(null); setIsoData(null);
                if (mainLayerRef.current) mainLayerRef.current.clearLayers();
                try {
                    const ranges = [];
                    const factor = rangeType === 'time' ? 60 : 1000;
                    for (let r = rangeInterval; r <= rangeMax; r += rangeInterval) ranges.push(r * factor);
                    if (ranges.length === 0 || ranges[ranges.length-1] !== rangeMax * factor) ranges.push(rangeMax * factor);
                    const profile = TRANSPORT_MODES.find(m => m.id === transportMode)?.subOptions.find(s => s.id === subProfile)?.apiProfile || 'driving-car';
                    const response = await fetch(`https://api.openrouteservice.org/v2/isochrones/${profile}`, {
                        method: 'POST', headers: { 'Authorization': apiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ locations: [[position[1], position[0]]], range: ranges, range_type: rangeType, units: 'm' })
                    });
                    if (!response.ok) throw new Error("API Request Failed");
                    const data = await response.json();
                    setIsoData(data);
                } catch (e) { setErrorMsg(`Error: ${e.message}. Using simulation.`); simulateIsochrones(); } 
                finally { setIsLoading(false); }
            };

            const simulateIsochrones = () => {
                const L = window.L;
                const factor = rangeType === 'time' ? 500 : 1000; 
                for (let r = rangeMax; r >= rangeInterval; r -= rangeInterval) {
                     const radius = r * factor * (Math.random() * 0.2 + 0.8);
                     const circle = L.circle(position, { radius: radius, fillColor: '#3388ff', fillOpacity: 0, color: 'none' });
                     circle.addTo(mainLayerRef.current);
                     const idx = Math.floor((r / rangeMax) * ISO_COLORS.length);
                     const color = ISO_COLORS[Math.min(idx, ISO_COLORS.length-1)];
                     circle.setStyle({ color: 'white', weight: 1, fillColor: color, fillOpacity: 0.6 });
                     const rangeVal = r;
                     const rangeUnit = rangeType === 'time' ? 'min' : 'km';
                     const rangeText = `${Math.max(0, rangeVal - rangeInterval)} - ${rangeVal} ${rangeUnit}`;
                     circle.bindTooltip(rangeText, { permanent: false, direction: 'center', className: 'iso-tooltip', sticky: true });
                }
            };

            const renderIsochrones = (geoJson) => {
                if (!geoJson || !mainLayerRef.current) return;
                const sorted = [...geoJson.features].sort((a, b) => b.properties.value - a.properties.value);
                L.geoJSON({ type: "FeatureCollection", features: sorted }, {
                    style: (feature) => {
                        const val = feature.properties.value;
                        const inputVal = rangeType === 'time' ? val / 60 : val / 1000;
                        const fraction = inputVal / rangeMax;
                        const colorIdx = Math.floor(fraction * (ISO_COLORS.length - 1));
                        const color = ISO_COLORS[colorIdx] || ISO_COLORS[ISO_COLORS.length - 1];
                        return { color: '#ffffff', weight: 1.5, fillColor: color, fillOpacity: 0.5, dashArray: '5, 5' };
                    },
                    onEachFeature: (feature, layer) => {
                        const val = feature.properties.value;
                        const inputVal = rangeType === 'time' ? val / 60 : val / 1000;
                        const rangeUnit = rangeType === 'time' ? 'min' : 'km';
                        const lowerBound = Math.max(0, inputVal - rangeInterval);
                        const rangeText = `${lowerBound} - ${inputVal} ${rangeUnit}`;
                        layer.bindTooltip(rangeText, { permanent: false, direction: 'center', className: 'iso-tooltip', sticky: true });
                    }
                }).addTo(mainLayerRef.current);
                const bounds = L.geoJSON(geoJson).getBounds();
                mapRef.current.fitBounds(bounds, { padding: [50, 50] });
            };

            const isNear = (p1, p2) => { return Math.abs(p1[0] - p2[0]) < 0.005 && Math.abs(p1[1] - p2[1]) < 0.005; };

            const renderConnectivity = () => {
                if (!connectivityLayerRef.current) return;
                connectivityLayerRef.current.clearLayers();
                const occupied = activeStationsRef.current || [];
                if (infraFilter.bridge) {
                    INFRASTRUCTURE_DATA.bridges.forEach(b => {
                        L.polyline(b.coords, { color: '#D97706', weight: 3, dashArray: '5,5' }).addTo(connectivityLayerRef.current);
                        const center = b.coords.length > 1 ? b.coords[Math.floor(b.coords.length/2)] : b.coords[0];
                        L.circleMarker(center, { radius: 0, opacity:0 }).addTo(connectivityLayerRef.current)
                         .bindTooltip(b.name, { permanent: true, direction: 'center', className: 'map-label', offset: [0,0] });
                    });
                }
                if (infraFilter.hub) {
                    INFRASTRUCTURE_DATA.hubs.forEach(h => {
                         if (occupied.some(p => isNear(p, h.coords))) return; 
                         const iconHtml = getStationIconHtml('hub', '#E11D48');
                         const icon = L.divIcon({ className: 'infra-icon', html: iconHtml, iconSize: [22, 22] });
                         L.marker(h.coords, { icon }).addTo(connectivityLayerRef.current)
                          .bindTooltip(h.name, { permanent: true, direction: 'right', offset: [12, 0], className: 'map-label' });
                    });
                }
                if (infraFilter.border) {
                    INFRASTRUCTURE_DATA.borders.forEach(b => {
                         if (occupied.some(p => isNear(p, b.coords))) return;
                         const icon = L.divIcon({ className: 'infra-icon', html: `<div style="background:#7C3AED; color:white; width:16px; height:16px; border-radius:50%; border:2px solid white;"></div>`, iconSize: [16, 16] });
                         L.marker(b.coords, { icon }).addTo(connectivityLayerRef.current)
                          .bindTooltip(b.name, { permanent: true, direction: 'right', offset: [10, 0], className: 'map-label' });
                    });
                }
                if (infraFilter.air) {
                    INFRASTRUCTURE_DATA.airports.forEach(a => {
                        if (occupied.some(p => isNear(p, a.coords))) return;
                        const iconHtml = getStationIconHtml('air', '#0EA5E9');
                        const icon = L.divIcon({ className: 'infra-icon', html: iconHtml, iconSize: [22, 22] });
                        L.marker(a.coords, { icon }).addTo(connectivityLayerRef.current)
                         .bindTooltip(a.name, { permanent: true, direction: 'top', offset: [0, -10], className: 'map-label' });
                    });
                }
            };

            const handleSearch = async () => {
                if (!searchQuery) return;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        const { lat, lon, display_name } = data[0];
                        updatePosition([lat, lon], display_name.split(',')[0]);
                        setShowSearch(false);
                    }
                } catch(e) {}
            };

            const getFilteredRoutes = () => {
                const valid = Object.entries(ROUTE_CONFIG)
                    .filter(([_, config]) => config.startYear <= year)
                    .map(([id, config]) => ({ id, ...config }));
                return historyFilter === 'all' ? valid : valid.filter(r => r.type === historyFilter);
            };
            
            useEffect(() => {
                if (!mainLayerRef.current) return;
                mainLayerRef.current.clearLayers();
                if (viewMode === 'isochrone') {
                    if (isoData) renderIsochrones(isoData);
                    updatePosition(position, addressLabel);
                    activeStationsRef.current = [];
                    renderConnectivity();
                } else if (viewMode === 'history') {
                    const prev = prevPropsRef.current;
                    const isYearChangeOnly = prev && prev.year !== year && prev.historyFilter === historyFilter && prev.selectedRouteId === selectedRouteId && prev.viewMode === viewMode;
                    const shouldFit = !isYearChangeOnly;
                    const displayedStations = renderHistoryLayers(shouldFit);
                    activeStationsRef.current = displayedStations || [];
                    renderConnectivity();
                }
                prevPropsRef.current = { viewMode, year, historyFilter, selectedRouteId };
            }, [viewMode, year, historyFilter, selectedRouteId, replayCount, isoData]);

            return (
                <div>
                    <div className="glass-panel">
                        <div className="panel-scroll-area">
                            <div className="main-title-group">
                                <div className="main-title-large">Greater Bay Area</div>
                                <div className="main-title-small">Part 2: Connectivity</div>
                            </div>

                            <div className="tab-group">
                                <button onClick={() => setViewMode('history')} className={`tab-btn ${viewMode === 'history' ? 'active' : ''}`}>History</button>
                                <button onClick={() => setViewMode('isochrone')} className={`tab-btn ${viewMode === 'isochrone' ? 'active' : ''}`}>Isochrone</button>
                            </div>

                            {viewMode === 'history' && (
                                <div className="animate-fade-in">
                                    <div className="header-section">
                                        <div className="current-year">{year}</div>
                                        <div className="subtitle">{YEAR_DATA[year].title}</div>
                                        <div className="slider-container">
                                            <input type="range" min="2017" max="2025" step="1" value={year} onChange={(e) => setYear(Number(e.target.value))} />
                                            <div className="slider-labels">
                                                <span>2017</span><span>2021</span><span>2025</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="event-section-title">Annual Context</div>
                                    <div className="event-card active">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="event-tag">Status</span>
                                            <span className="text-xs text-slate-400 font-mono">{year}</span>
                                        </div>
                                        <div className="text-sm font-bold text-slate-700 mb-1">{YEAR_DATA[year].event}</div>
                                        <div className="text-xs text-slate-500 leading-relaxed">{YEAR_DATA[year].desc}</div>
                                    </div>

                                    <div className="event-section-title mt-6">Transport Networks</div>
                                    <div className="flex gap-2 mb-3 overflow-x-auto pb-1 no-scrollbar">
                                        {[{id:'all', label:'All'}, {id:'hsr', label:'HSR'}, {id:'metro', label:'Metro'}, {id:'bus', label:'Bus'}, {id:'drive', label:'Drive'}].map(cat => (
                                            <button key={cat.id} 
                                                onClick={() => { setHistoryFilter(cat.id); setSelectedRouteId(null); setReplayCount(c=>c+1); }} 
                                                className={`text-[10px] px-3 py-1 rounded-full border transition-all ${historyFilter === cat.id ? 'bg-[#0E7490] text-white border-[#0E7490]' : 'bg-white text-slate-500 border-slate-200'}`}>
                                                {cat.label}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="flex flex-col gap-2">
                                        {getFilteredRoutes().map(route => {
                                            const isNew = route.startYear === year;
                                            return (
                                            <div key={route.id} onClick={() => { 
                                                if (selectedRouteId === route.id) setSelectedRouteId(null);
                                                else { setSelectedRouteId(route.id); setReplayCount(c=>c+1); }
                                            }} className={`event-card ${selectedRouteId === route.id ? 'active' : ''}`} style={{marginBottom:'4px', padding:'10px', cursor:'pointer'}}>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs font-bold text-slate-700">{route.name}</span>
                                                    <div className="flex items-center gap-1">
                                                        {isNew ? <span className="px-1.5 py-0.5 bg-amber-500 text-white text-[9px] font-bold rounded animate-pulse">New</span>
                                                         : <span className="px-1.5 py-0.5 bg-slate-100 text-slate-400 text-[9px] font-medium rounded border border-slate-200 font-mono">{route.startYear}</span>}
                                                    </div>
                                                </div>
                                                {selectedRouteId === route.id && (
                                                    <div className="mt-3 pt-3 border-t border-slate-100 animate-fade-in">
                                                        <div className="grid grid-cols-2 gap-3 mb-3">
                                                            <div className="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                                                 <div className="flex items-center gap-1.5 text-slate-400 text-[9px] font-bold uppercase mb-0.5">
                                                                    <Icon name="Clock" size={12} className="text-blue-500"/> Est. Time
                                                                 </div>
                                                                 <div className="text-sm font-bold text-slate-700 font-mono">{route.time}</div>
                                                            </div>
                                                            <div className="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                                                 <div className="flex items-center gap-1.5 text-slate-400 text-[9px] font-bold uppercase mb-0.5">
                                                                    <Icon name="DollarSign" size={12} className="text-emerald-500"/> Cost
                                                                 </div>
                                                                 <div className="text-sm font-bold text-slate-700 font-mono">{route.cost}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-xs font-serif text-slate-600 italic mb-2 pl-2 border-l-2 border-primary-500">"{route.desc}"</div>
                                                        <div className="text-[11px] text-slate-500 leading-relaxed bg-slate-50/50 p-2 rounded border border-slate-100">
                                                            <span className="font-bold text-slate-700 block mb-1 text-[10px] uppercase tracking-wider">Experience</span>
                                                            {route.experience}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )})}
                                    </div>
                                </div>
                            )}

                            {viewMode === 'isochrone' && (
                                <div className="animate-fade-in">
                                    <div className="event-section-title">Configuration</div>
                                    <div className="mb-4">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Start Location</label>
                                        <div className="flex items-center gap-2 bg-white/50 border border-white p-2 rounded-lg mb-2">
                                            <Icon name="MapPin" size={14} className="text-[#0E7490]"/>
                                            <div className="flex-1 min-w-0 text-xs font-medium text-slate-700 truncate">{addressLabel}</div>
                                            <button onClick={() => setShowSearch(!showSearch)} className="text-slate-400 hover:text-[#0E7490]"><Icon name="Search" size={14}/></button>
                                        </div>
                                        {showSearch && (
                                            <div className="flex gap-1 mb-2">
                                                <input className="flex-1 bg-white/80 border border-slate-200 text-xs p-1.5 rounded" placeholder="Search place..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSearch()}/>
                                                <button onClick={handleSearch} className="bg-[#0E7490] text-white px-3 rounded text-xs">Go</button>
                                            </div>
                                        )}
                                        <div className="flex flex-wrap gap-1">
                                            {PRESETS.map(p => (
                                                <button key={p.name} onClick={() => updatePosition(p.coords, p.name)} className="text-[9px] bg-white border border-slate-200 px-2 py-1 rounded hover:border-[#06B6D4] text-slate-600 transition-colors">{p.name}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mb-4">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Mode</label>
                                        <div className="grid grid-cols-3 gap-2 mb-2">
                                            {TRANSPORT_MODES.map(m => (
                                                <button key={m.id} onClick={() => { setTransportMode(m.id); setSubProfile(m.subOptions[0].id); }} className={`flex flex-col items-center justify-center p-2 rounded-lg border transition-all ${transportMode === m.id ? 'bg-[#E0F2FE] border-[#0E7490] text-[#0E7490]' : 'bg-white/50 border-transparent text-slate-400 hover:bg-white'}`}>
                                                    <Icon name={m.icon} size={16} className="mb-1"/>
                                                    <span className="text-[9px] font-medium">{m.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mb-6">
                                        <div className="flex justify-between text-[10px] mb-1">
                                            <span className="font-bold text-slate-500">Range ({rangeType})</span>
                                            <span className="font-mono text-[#0E7490]">{rangeMax}</span>
                                        </div>
                                        <div className="slider-container" style={{marginBottom:'8px', marginTop:'0'}}>
                                            <input type="range" min="5" max="120" step="5" value={rangeMax} onChange={e => setRangeMax(Number(e.target.value))} />
                                        </div>
                                        <div className="flex bg-white/50 p-1 rounded-lg border border-slate-200">
                                            <button onClick={() => setRangeType('time')} className={`flex-1 py-1 text-[10px] font-bold rounded transition-all ${rangeType === 'time' ? 'bg-[#0E7490] text-white shadow-sm' : 'text-slate-400'}`}>Time (min)</button>
                                            <button onClick={() => setRangeType('distance')} className={`flex-1 py-1 text-[10px] font-bold rounded transition-all ${rangeType === 'distance' ? 'bg-[#0E7490] text-white shadow-sm' : 'text-slate-400'}`}>Dist (km)</button>
                                        </div>
                                    </div>
                                    <div className="mb-4">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">API Key (OpenRouteService)</label>
                                        <div className="flex items-center gap-2 bg-white/50 border border-slate-200 p-2 rounded-lg">
                                            <Icon name="Key" size={14} className="text-[#0E7490]"/>
                                            <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="flex-1 bg-transparent text-[10px] font-mono text-slate-600 outline-none truncate" placeholder="Enter ORS API Key" />
                                        </div>
                                    </div>
                                    <button onClick={fetchIsochrones} disabled={isLoading} className={`w-full py-3 rounded-xl font-bold text-sm text-white shadow-lg flex items-center justify-center gap-2 transition-all ${isLoading ? 'bg-slate-400' : 'bg-gradient-to-r from-[#0E7490] to-[#06B6D4] hover:shadow-xl'}`}>
                                        {isLoading ? 'Calculating...' : 'Generate Isochrone'}
                                    </button>
                                    {errorMsg && <div className="mt-2 text-[10px] text-red-500 bg-red-50 p-2 rounded">{errorMsg}</div>}
                                </div>
                            )}
                        </div>
                    </div>
                    {viewMode === 'isochrone' && (
                        <div className="legend-unified" style={{top:'24px', bottom:'auto'}}>
                            <div className="legend-title">Isochrone Ranges</div>
                            {[...Array(Math.ceil(rangeMax/rangeInterval))].map((_, i) => {
                                const val = (i+1)*rangeInterval;
                                const lower = Math.max(0, val - rangeInterval);
                                const unit = rangeType === 'time' ? 'min' : 'km';
                                const fraction = val / rangeMax;
                                const colorIdx = Math.floor(fraction * (ISO_COLORS.length - 1));
                                const color = ISO_COLORS[colorIdx] || ISO_COLORS[ISO_COLORS.length - 1];
                                return (
                                    <div key={i} className="legend-item">
                                        <div className="flex items-center gap-2">
                                            <div style={{width:12, height:12, borderRadius:4, background: color, border:'1px solid rgba(0,0,0,0.1)'}}></div>
                                            <span className="text-[10px] text-slate-600 font-medium font-mono">{lower} - {val} {unit}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    <div className="legend-unified">
                        <div className="legend-title">Connectivity Layers</div>
                        <div className="legend-item" onClick={() => setInfraFilter(p => ({...p, hub: !p.hub}))}>
                            <div className="flex items-center gap-2"><div style={{width:10, height:10, borderRadius:'50%', background: COLORS.hsr}}></div>High Speed Hubs</div>
                            {infraFilter.hub && <Icon name="Check" size={12} className="text-[#0E7490] ml-auto"/>}
                        </div>
                        <div className="legend-item" onClick={() => setInfraFilter(p => ({...p, border: !p.border}))}>
                            <div className="flex items-center gap-2"><div style={{width:10, height:10, borderRadius:'50%', background: '#7C3AED'}}></div>Border Controls</div>
                            {infraFilter.border && <Icon name="Check" size={12} className="text-[#0E7490] ml-auto"/>}
                        </div>
                        <div className="legend-item" onClick={() => setInfraFilter(p => ({...p, air: !p.air}))}>
                            <div className="flex items-center gap-2"><div style={{width:10, height:10, borderRadius:'50%', background: '#0EA5E9'}}></div>Airports</div>
                            {infraFilter.air && <Icon name="Check" size={12} className="text-[#0E7490] ml-auto"/>}
                        </div>
                        <div className="legend-item" onClick={() => setInfraFilter(p => ({...p, bridge: !p.bridge}))}>
                            <div className="flex items-center gap-2"><div style={{width:10, height:4, background: '#D97706'}}></div>Sea Bridges</div>
                            {infraFilter.bridge && <Icon name="Check" size={12} className="text-[#0E7490] ml-auto"/>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- PART 3 LOGIC (React) -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. ENHANCED VISUALIZATION COMPONENTS ---

        // 1. RAIL VIZ (Speed Focus)
        const RailViz = () => (
            <div className="flex flex-col h-full justify-between py-2">
                <div className="flex items-center gap-2 opacity-40">
                    <div className="w-16 text-[10px] font-mono uppercase tracking-wider text-right">East Rail</div>
                    <div className="flex-1 h-1 bg-slate-300 rounded-full overflow-hidden">
                        <div className="h-full w-full bg-slate-400 opacity-50 repeating-linear-gradient-45"></div>
                    </div>
                    <div className="text-xs font-bold text-slate-500">45m</div>
                </div>
                
                <div className="flex flex-col gap-1">
                    <div className="flex justify-between items-end">
                        <span className="text-xs font-bold text-primary uppercase tracking-wider">HSR / XRL</span>
                        <i className="fas fa-bolt text-secondary animate-pulse"></i>
                    </div>
                    <div className="h-12 w-full bg-gradient-to-r from-slate-100 to-accent rounded-lg relative overflow-hidden border border-secondary/20 group">
                        <div className="absolute inset-0 bg-white/50 backdrop-blur-[1px] z-10 flex items-center pl-3">
                            <span className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary italic tracking-tighter">
                                14<span className="text-sm font-normal text-primary ml-1 not-italic">min</span>
                            </span>
                        </div>
                        {/* Moving Train Effect */}
                        <div className="absolute top-0 bottom-0 w-1/2 bg-gradient-to-r from-transparent via-secondary/20 to-transparent -skew-x-12 animate-[slideUp_1s_infinite_linear] translate-x-[-100%] group-hover:translate-x-[200%] transition-all duration-700"></div>
                    </div>
                </div>
            </div>
        );

        // 2. FLOW VIZ (South vs North)
        const FlowViz = () => (
            <div className="flex h-full items-center justify-around">
                <div className="flex flex-col items-center opacity-40 scale-90">
                    <i className="fas fa-arrow-down text-2xl text-slate-400 mb-1"></i>
                    <span className="text-[10px] font-mono text-slate-500">Southbound</span>
                </div>
                <div className="h-12 w-[1px] bg-slate-200"></div>
                <div className="flex flex-col items-center relative">
                    <div className="absolute -inset-4 bg-accent rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i className="fas fa-arrow-up text-4xl text-primary mb-1 animate-bounce"></i>
                    <span className="text-xs font-bold text-primary uppercase tracking-wide">Northbound</span>
                </div>
            </div>
        );

        // 3. CLEARANCE VIZ (Time Collapse)
        const ClearanceViz = () => (
            <div className="h-full flex flex-col justify-center gap-4">
                <div className="flex items-center gap-3 opacity-50">
                    <div className="w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center">
                        <i className="fas fa-passport text-slate-400 text-xs"></i>
                    </div>
                    <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div className="w-3/4 h-full bg-slate-300"></div>
                    </div>
                    <span className="text-xs font-mono">30m</span>
                </div>
                
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-lg text-white">
                        <i className="fas fa-fingerprint text-sm"></i>
                    </div>
                    <div className="flex-1">
                        <div className="text-[10px] text-primary font-bold uppercase mb-1">Bio-Auth Passage</div>
                        <div className="flex items-baseline gap-2">
                             <span className="text-3xl font-black text-slate-800 leading-none">7</span>
                             <span className="text-xs text-slate-500 font-medium">seconds</span>
                        </div>
                    </div>
                </div>
            </div>
        );

        // 4. CAR RIGHTS (Plate Viz)
        const PlateViz = () => (
            <div className="h-full flex flex-col justify-between">
                <div className="bg-slate-800 text-white/50 p-2 rounded text-[10px] font-mono text-center opacity-60">
                    FV-2018 [Restricted]
                </div>
                <div className="text-center my-1 text-slate-300 text-[10px]"><i className="fas fa-arrow-down"></i></div>
                <div className="bg-gradient-to-r from-primary to-secondary p-[1px] rounded shadow-sm">
                    <div className="bg-white p-2 rounded-[3px] flex items-center justify-between">
                         <span className="text-primary font-bold text-xs uppercase">HK‚Ä¢Public</span>
                         <i className="fas fa-check-circle text-secondary text-xs"></i>
                    </div>
                </div>
            </div>
        );

         // 5. CARGO VIZ (Port Function)
         const CargoViz = () => (
            <div className="h-full flex items-center justify-center gap-4">
                 <div className="text-center opacity-40">
                    <div className="w-10 h-10 border border-dashed border-slate-400 rounded flex items-center justify-center mb-1 mx-auto">
                        <i className="fas fa-box text-slate-400"></i>
                    </div>
                    <div className="text-[9px] uppercase">Freight</div>
                 </div>
                 <i className="fas fa-chevron-right text-secondary text-xs"></i>
                 <div className="text-center">
                    <div className="w-12 h-12 bg-accent border border-secondary rounded-full flex items-center justify-center mb-1 mx-auto shadow-sm">
                        <i className="fas fa-user-friends text-primary"></i>
                    </div>
                    <div className="text-[9px] font-bold text-primary uppercase">People</div>
                 </div>
            </div>
        );

        // 6. FINANCE VIZ (Cash vs E-Wallet)
        const FinanceViz = () => (
            <div className="h-full flex flex-col items-center justify-center relative overflow-hidden">
                <div className="relative w-16 h-16 flex items-center justify-center mb-2">
                    <div className="absolute animate-swap-out flex items-center justify-center bg-amber-400 rounded-full w-12 h-12 border-2 border-amber-600 shadow-sm text-amber-700">
                         <span className="font-bold text-lg">$</span>
                    </div>
                    <i className="fas fa-qrcode text-5xl text-primary absolute animate-swap-in"></i>
                </div>
                <div className="text-[10px] text-slate-400 font-mono flex items-center gap-2">
                    <span className="opacity-50 line-through">CASH</span>
                    <i className="fas fa-long-arrow-alt-right text-secondary"></i>
                    <span className="text-primary font-bold">DIGITAL</span>
                </div>
            </div>
        );

        // --- 2. DATASETS ---

        const bentoData = [
            { 
                id: 1, 
                title: "Time-Space Compression", 
                subtitle: "Metro vs HSR", 
                viz: <RailViz/>, 
                stat: "-68%", 
                statLabel: "Travel Time",
                colSpan: "col-span-1 md:col-span-2", 
                rowSpan: "row-span-1",
                bg: "bg-white",
                driver: {
                    year: "2018 & 2022",
                    tag: "Infrastructure",
                    image: "https://images.unsplash.com/photo-1474487548417-781cb714c2f0?auto=format&fit=crop&w=800",
                    title: "Rail Network Integration",
                    desc: "The commissioning of the High Speed Rail (XRL) compressed travel to Guangzhou to 48 mins, while the East Rail Line Cross-Harbour Extension connected HK Island directly to the Shenzhen border."
                }
            },
            { 
                id: 4, 
                title: "The Frictionless Border", 
                subtitle: "Clearance Time", 
                viz: <ClearanceViz/>, 
                stat: "7s", 
                statLabel: "Avg. Pass Time",
                colSpan: "col-span-1", 
                rowSpan: "row-span-1 md:row-span-2",
                bg: "bg-gradient-to-b from-white to-accent",
                driver: {
                    year: "2018 - 2024",
                    tag: "Technology",
                    image: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=800",
                    title: "Smart Clearance Evolution",
                    desc: "From 'Co-location' arrangements to the removal of health declarations and the pilot of biometric 'Senseless Clearance', physical and digital barriers have been systematically dismantled."
                }
            },
            { 
                id: 2, 
                title: "Flow Reversal", 
                subtitle: "Shopping Trend", 
                viz: <FlowViz/>, 
                stat: "3x", 
                statLabel: "Northbound Growth",
                colSpan: "col-span-1", 
                rowSpan: "row-span-1",
                bg: "bg-white",
                driver: {
                    year: "2023",
                    tag: "Consumption",
                    image: "https://images.unsplash.com/photo-1534452203293-494d7ddbf7e0?auto=format&fit=crop&w=800",
                    title: "The Costco Effect",
                    desc: "Post-pandemic reopening combined with currency advantages led to a surge in northbound consumption, driven by warehouse supermarkets like Sam's Club filling a gap in HK's retail market."
                }
            },
            { 
                id: 3, 
                title: "Democratized Driving", 
                subtitle: "Vehicle Rights", 
                viz: <PlateViz/>, 
                stat: "500k+", 
                statLabel: "Applications",
                colSpan: "col-span-1", 
                rowSpan: "row-span-1",
                bg: "bg-white",
                driver: {
                    year: "2023",
                    tag: "Policy",
                    image: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800",
                    title: "Northbound Travel Scheme",
                    desc: "The 'Northbound Travel for HK Vehicles' policy allowed single-plate private cars to enter Guangdong via the HZMB, removing the expensive barrier of dual license plates."
                }
            },
            { 
                id: 5, 
                title: "Port Evolution", 
                subtitle: "Huanggang Function", 
                viz: <CargoViz/>, 
                stat: "100%", 
                statLabel: "Passenger Focus",
                colSpan: "col-span-1 md:col-span-1 lg:col-span-1", 
                rowSpan: "row-span-1",
                bg: "bg-white",
                driver: {
                    year: "2020",
                    tag: "Urban Planning",
                    image: "https://images.unsplash.com/photo-1578575437130-527eed3abbec?auto=format&fit=crop&w=800",
                    title: "Port Function Split",
                    desc: "The opening of Liantang/Heung Yuen Wai port implemented the 'East-in East-out' cargo strategy, allowing older ports like Huanggang to be redeveloped exclusively for passenger use."
                }
            },
            { 
                id: 6, 
                title: "Financial Fusion", 
                subtitle: "Cash vs. E-Wallet", 
                viz: <FinanceViz/>, 
                stat: "95%", 
                statLabel: "Cashless Coverage",
                colSpan: "col-span-1 md:col-span-1", 
                rowSpan: "row-span-1",
                bg: "bg-white",
                driver: {
                    year: "2023 - 2024",
                    tag: "FinTech",
                    image: "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&w=800",
                    title: "E-Wallet Interoperability",
                    desc: "AlipayHK and WeChat Pay HK achieved full coverage of mainland merchants and public transport, eliminating the need for cash exchange and effectively unifying the payment ecosystem."
                }
            }
        ];

        // FULL PDF DATA MAPPING
        const timelineData = [
            { 
                year: "Pre-2017", 
                title: "The Hard Border", 
                tag: "Baseline", 
                img: "https://images.unsplash.com/photo-1558289721-39656828859e?auto=format&fit=crop&w=800",
                desc: "Establishment of fundamental frameworks and initial connectivities.",
                events: [
                    { year: "2003", title: "CEPA & Free Travel", tag: "Policy", desc: "Signed CEPA and launched 'Individual Visit Scheme', sparking the first explosion in cross-border flow." },
                    { year: "2007", title: "Shenzhen Bay Port", tag: "Infra", desc: "Opened with pioneering 'Co-location' model, laying legal groundwork for future HSR clearance." },
                    { year: "2010", title: "Qianhai Plan", tag: "Strategy", desc: "State Council approved Qianhai plan, establishing it as a 'Special Zone within Special Zone' for finance/legal coop." },
                    { year: "2015", title: "Guangdong FTZ", tag: "Policy", desc: "Qianhai-Shekou area launched as FTZ, entering the 'Free Trade Era' with accelerated financial innovation." },
                    { year: "2016", title: "Stock Connect", tag: "Finance", desc: "Shenzhen-Hong Kong Stock Connect launched, directly linking secondary capital markets." }
                ]
            },
            { 
                year: "2017", 
                title: "The Blueprint", 
                tag: "Policy", 
                img: "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?auto=format&fit=crop&w=800",
                desc: "Resolving disputes and setting national strategies.",
                events: [
                    { year: "Jan", title: "River Loop Memo", tag: "Policy", desc: "Signed memorandum for River Loop 'Co-development', resolving 20-year ownership disputes." },
                    { year: "Jul", title: "Bond Connect", tag: "Finance", desc: "'Northbound Trading' launched, allowing foreign investors to enter the mainland bond market via HK." },
                    { year: "Jul", title: "GBA Framework", tag: "Strategy", desc: "Signed 'Framework Agreement on Deepening Guangdong-HK-Macao Cooperation', elevating GBA to national strategy." },
                    { year: "Dec", title: "Tech Park Inc.", tag: "Org", desc: "HK-SZ Innovation and Technology Park Ltd formed to manage River Loop construction and operation." }
                ]
            },
            { 
                year: "2018", 
                title: "Infrastructure Leap", 
                tag: "Infra", 
                img: "https://images.unsplash.com/photo-1532189912648-2895f32a0c4f?auto=format&fit=crop&w=800",
                desc: "Physical connections upgraded to world-class standards.",
                events: [
                    { year: "Feb", title: "31 Measures", tag: "Welfare", desc: "Released '31 Measures' to benefit HK people, gradually removing employment barriers in the mainland." },
                    { year: "Sep", title: "High Speed Rail", tag: "Infra", desc: "XRL HK Section opened; West Kowloon implemented 'Co-location', connecting HK to National HSR grid." },
                    { year: "Sep", title: "Residency ID", tag: "Policy", desc: "HK/Macao/Taiwan Residence Permit applications started, granting 'National Treatment' for ID authentication." },
                    { year: "Oct", title: "HZMB Bridge", tag: "Infra", desc: "Hong Kong-Zhuhai-Macao Bridge opened, physically closing the loop of the Pearl River Estuary 1-hour living circle." }
                ]
            },
            { 
                year: "2019", 
                title: "GBA Strategy", 
                tag: "Strategy", 
                img: "https://images.unsplash.com/photo-1619175474640-5a98135870f7?auto=format&fit=crop&w=800",
                desc: "Top-level design amidst social challenges.",
                events: [
                    { year: "Feb", title: "GBA Outline Plan", tag: "Strategy", desc: "Outline Development Plan released, clarifying Hong Kong's status as a core engine and quality living circle." },
                    { year: "Jun", title: "Social Unrest", tag: "Social", desc: "Social incidents in Hong Kong hindered port operations; 'psychological distance' temporarily widened." },
                    { year: "Nov", title: "16 Measures", tag: "Welfare", desc: "Launched 16 measures including exemption from social security restrictions for buying houses in GBA." }
                ]
            },
            { 
                year: "2020", 
                title: "The Freeze", 
                tag: "Pandemic", 
                img: "https://images.unsplash.com/photo-1584036561566-b45238f2e26f?auto=format&fit=crop&w=800",
                desc: "Pandemic forces physical closure but accelerates digital reform.",
                events: [
                    { year: "Feb", title: "Border Closure", tag: "Health", desc: "Major land passenger ports suspended services due to outbreak; cross-border flow almost ceased." },
                    { year: "Aug", title: "Heung Yuen Wai", tag: "Infra", desc: "Liantang/Heung Yuen Wai Port opened (cargo first), ensuring material supply during the pandemic." },
                    { year: "Oct", title: "SZ Reform Pilot", tag: "Policy", desc: "Shenzhen implemented comprehensive reform pilot plan, gaining more autonomy in HK-related opening up." }
                ]
            },
            { 
                year: "2021", 
                title: "Digital Integration", 
                tag: "Tech", 
                img: "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&w=800",
                desc: "Health codes and strategic expansions.",
                events: [
                    { year: "All", title: "Health Code", tag: "Tech", desc: "'Return2hk/Come2hk' schemes promoted digital synchronization of health codes and ID systems." },
                    { year: "Sep", title: "Qianhai Expansion", tag: "Strategy", desc: "'Qianhai Plan' released, expanding the cooperation zone area by 8 times." },
                    { year: "Sep", title: "Wealth Connect", tag: "Finance", desc: "Cross-boundary Wealth Management Connect launched for individual investments." },
                    { year: "Oct", title: "Northern Metropolis", tag: "Strategy", desc: "HK proposed 'Northern Metropolis Strategy', establishing 'Twin Cities, Three Circles' framework." }
                ]
            },
            { 
                year: "2022", 
                title: "Transport Links", 
                tag: "Transport", 
                img: "https://images.unsplash.com/photo-1582252445853-273618685cb5?auto=format&fit=crop&w=800",
                desc: "Railways cross the harbour and new cultural landmarks.",
                events: [
                    { year: "May", title: "East Rail Ext.", tag: "Transport", desc: "Cross-harbour extension opened. Admiralty directly connects to Lo Wu. Rail crosses Victoria Harbour to border." },
                    { year: "Jun", title: "Nansha Plan", tag: "Strategy", desc: "Nansha Plan released; HKUST (Guangzhou) opened, materializing the sci-tech innovation corridor." },
                    { year: "Jul", title: "HK Palace Museum", tag: "Culture", desc: "HK Palace Museum opened, becoming a new cultural tourism landmark for 'multi-destination' travel." }
                ]
            },
            { 
                year: "2023", 
                title: "The Reopening", 
                tag: "Milestone", 
                img: "https://images.unsplash.com/photo-1622627916327-0243486be4f4?auto=format&fit=crop&w=800",
                desc: "Borders open and new travel policies unleash demand.",
                events: [
                    { year: "Feb", title: "Full Reopening", tag: "Milestone", desc: "Ports fully resumed normal clearance; quotas/appointments cancelled. Dual-city life restarted." },
                    { year: "Jul", title: "Northbound Travel", tag: "Policy", desc: "'Northbound Travel for HK Vehicles' implemented. HK single-plate cars can enter Guangdong via HZMB." },
                    { year: "Aug", title: "Hetao SZ Plan", tag: "Policy", desc: "Shenzhen Park Development Plan for Hetao Zone released, accelerating collaborative mechanisms." },
                    { year: "All", title: "Consumption Trend", tag: "Trend", desc: "HK people heading north to Sam's Club/Costco became a craze; cross-city grocery shopping became normal." }
                ]
            },
            { 
                year: "2024", 
                title: "Living Circle", 
                tag: "Network", 
                img: "https://images.unsplash.com/photo-1623838382902-140087790b9b?auto=format&fit=crop&w=800",
                desc: "Expanding the radius of life to the Golden Inner Bay.",
                events: [
                    { year: "Jan", title: "Tax Incentives", tag: "Welfare", desc: "'Hong Kong People, Hong Kong Tax' policy expanded in Qianhai; individual income tax differential exempted." },
                    { year: "Mar", title: "Professional Rec", tag: "Social", desc: "HK completed Article 23 legislation; Guangdong advanced mutual recognition of qualifications (construction/medical)." },
                    { year: "Jun", title: "SZ-ZS Link", tag: "Network", desc: "Shenzhen-Zhongshan Link opened. Combined with Northbound Travel, living circle expands to Zhongshan." },
                    { year: "Jun", title: "Sleeper HSR", tag: "Transport", desc: "Beijing/Shanghai-HK sleeper HSR debuted. 'Overnight travel' speeds up business exchanges." },
                    { year: "Dec", title: "Data Verification", tag: "Tech", desc: "Cross-border data verification platform launched for compliant credit data verification." }
                ]
            },
            { 
                year: "2025", 
                title: "Future Fusion", 
                tag: "Future", 
                img: "https://images.unsplash.com/photo-1516245834210-c4c14278733f?auto=format&fit=crop&w=800",
                desc: "Seamless borders and deep institutional integration.",
                events: [
                    { year: "Mar", title: "Western Rail", tag: "Infra", desc: "HK-SZ Western Rail (Hung Shui Kiu - Qianhai) enters detailed planning; exploring new clearance modes." },
                    { year: "Aug", title: "Medical Bond", tag: "Welfare", desc: "Elderly Health Care Vouchers cover GBA (including dental/Grade 3A hospitals); medical welfare crosses the river." },
                    { year: "Nov", title: "National Games", tag: "Sports", desc: "15th National Games co-hosted. Seamless docking in clearance, volunteering, and event organization." },
                    { year: "End", title: "Hetao HK Park", tag: "Tech", desc: "First batch of buildings in Hetao HK Park completed. Life health & AI enterprises move in." },
                    { year: "All", title: "Seamless Border", tag: "Future", desc: "Shatoujiao and other ports pilot 'Co-operative Inspection' or biometric 'Senseless Clearance'." }
                ]
            }
        ];

        // --- 3. SUB-COMPONENTS ---

        // Modal for Timeline
        const Modal = ({ item, onClose }) => (
            <div className="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in" onClick={onClose}>
                <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                    {/* Header Image */}
                    <div className="h-48 md:h-64 relative shrink-0">
                        <img src={item.img} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent opacity-90"></div>
                        <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 bg-black/30 rounded-full text-white backdrop-blur hover:bg-black/50 transition flex items-center justify-center"><i className="fas fa-times"></i></button>
                        <div className="absolute bottom-6 left-6 text-white">
                            <span className="bg-secondary text-white px-2 py-1 rounded text-xs font-mono font-bold uppercase mb-2 inline-block">{item.year}</span>
                            <h2 className="text-3xl font-bold">{item.title}</h2>
                        </div>
                    </div>
                    
                    {/* Scrollable Content */}
                    <div className="p-6 md:p-8 overflow-y-auto custom-scrollbar">
                        <p className="text-lg text-slate-700 leading-relaxed mb-6 font-medium">{item.desc}</p>
                        
                        <div className="space-y-6">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Key Events Timeline</div>
                            
                            {item.events.map((event, idx) => (
                                <div key={idx} className="relative pl-6 border-l-2 border-slate-200 hover:border-primary transition-colors group">
                                    <div className="absolute -left-[5px] top-1 w-2 h-2 rounded-full bg-slate-300 group-hover:bg-primary transition-colors"></div>
                                    <div className="flex flex-wrap items-baseline gap-2 mb-1">
                                        <span className="text-sm font-bold text-primary font-mono">{event.year}</span>
                                        <span className="text-xs px-2 py-0.5 bg-slate-100 text-slate-500 rounded font-medium uppercase tracking-wide">{event.tag}</span>
                                    </div>
                                    <h4 className="font-bold text-slate-800 text-base mb-1">{event.title}</h4>
                                    <p className="text-sm text-slate-600 leading-relaxed">{event.desc}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );

        // New Modal for Drivers (Single Event)
        const DriverModal = ({ driver, onClose }) => (
            <div className="fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in" onClick={onClose}>
                <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="h-56 relative shrink-0">
                        <img src={driver.image} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/30 to-transparent"></div>
                        <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 bg-black/30 rounded-full text-white backdrop-blur hover:bg-black/50 transition flex items-center justify-center"><i className="fas fa-times"></i></button>
                        <div className="absolute bottom-6 left-6 text-white pr-6">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="bg-secondary text-white px-2 py-0.5 rounded text-[10px] font-mono font-bold uppercase">{driver.year}</span>
                                <span className="text-xs font-bold uppercase tracking-wider opacity-80 border border-white/30 px-2 py-0.5 rounded">{driver.tag}</span>
                            </div>
                            <h2 className="text-2xl font-bold leading-tight">{driver.title}</h2>
                        </div>
                    </div>
                    <div className="p-6 md:p-8 bg-white">
                        <div className="flex gap-4">
                            <div className="shrink-0 mt-1">
                                <div className="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-primary shadow-sm">
                                    <i className="fas fa-layer-group"></i>
                                </div>
                            </div>
                            <div>
                                <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">The Driver Event</h4>
                                <p className="text-slate-700 leading-relaxed font-medium text-base">
                                    {driver.desc}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 px-6 py-3 border-t border-slate-100 text-right">
                         <button onClick={onClose} className="text-xs font-bold text-slate-500 hover:text-primary uppercase tracking-wider transition-colors">Close</button>
                    </div>
                </div>
            </div>
        );

        // --- 4. MAIN SCREENS ---

        const DashboardScreen = ({ onNavigate }) => {
            const [selectedDriver, setSelectedDriver] = useState(null);

            return (
                <div className="h-full flex flex-col p-6 md:p-8 max-w-7xl mx-auto w-full relative">
                    {/* Header */}
                    <div className="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4 animate-slide-up">
                        <div>
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-accent text-primary text-[10px] font-bold tracking-wider mb-3 border border-secondary/30">
                                <i className="fas fa-database"></i> PART 3: DATA NARRATIVE
                            </div>
                            <h1 className="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">
                                Borderless <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Dual City</span>
                            </h1>
                            <p className="text-slate-500 mt-2 max-w-lg leading-relaxed">
                                From administrative boundary to metropolitan interface.
                                <br/>Tracking the structural dissolution of distance (2017-2025).
                            </p>
                        </div>
                        <button onClick={onNavigate} className="group flex items-center gap-3 px-6 py-3 bg-slate-900 text-white rounded-full font-bold text-sm hover:bg-primary transition-colors shadow-lg hover:shadow-primary/30">
                            <span>Explore Timeline</span>
                            <i className="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>

                    {/* Bento Grid */}
                    <div className="flex-1 min-h-0 relative"> {/* min-h-0 allows scroll within flex */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 auto-rows-fr gap-4 h-full pb-2 md:pb-0 overflow-y-auto custom-scrollbar pr-2">
                            {bentoData.map((item, idx) => (
                                <div key={item.id} 
                                    onClick={() => setSelectedDriver(item.driver)}
                                    className={`bento-card relative rounded-2xl p-5 border border-slate-200/60 shadow-sm flex flex-col justify-between overflow-hidden group cursor-pointer hover:border-primary/50 ${item.colSpan} ${item.rowSpan} ${item.bg}`}
                                    style={{animationDelay: `${idx * 100}ms`}}
                                >
                                    <div className="flex justify-between items-start z-10 pointer-events-none">
                                        <div>
                                            <h3 className="font-bold text-slate-700 text-sm md:text-base">{item.title}</h3>
                                            <p className="text-xs text-slate-400">{item.subtitle}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xl md:text-2xl font-black text-slate-800">{item.stat}</div>
                                            <div className="text-[9px] font-bold text-primary uppercase tracking-wide">{item.statLabel}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 mt-4 mb-2 relative z-10 pointer-events-none">
                                        {item.viz}
                                    </div>
                                    
                                    {/* Background Decoration */}
                                    <div className="absolute -bottom-4 -right-4 w-24 h-24 bg-gradient-to-br from-secondary/10 to-transparent rounded-full blur-2xl group-hover:bg-secondary/20 transition-colors pointer-events-none"></div>

                                    {/* Interaction Hint */}
                                    <div className="absolute top-3 right-3 w-6 h-6 rounded-full bg-slate-100/50 backdrop-blur text-slate-400 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100">
                                        <i className="fas fa-search-plus text-xs"></i>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Driver Modal */}
                    {selectedDriver && <DriverModal driver={selectedDriver} onClose={() => setSelectedDriver(null)} />}
                </div>
            );
        };

        const TimelineScreen = ({ onNavigateBack, onNavigateForward, setSelectedItem }) => {
            const scrollRef = useRef(null);

            useEffect(() => {
                const el = scrollRef.current;
                if(el) {
                    const handleWheel = (e) => {
                        if (e.deltaY !== 0) {
                            e.preventDefault();
                            el.scrollLeft += e.deltaY;
                        }
                    };
                    el.addEventListener("wheel", handleWheel);
                    return () => el.removeEventListener("wheel", handleWheel);
                }
            }, []);

            // Scroll Handlers for Buttons
            const scroll = (direction) => {
                if(scrollRef.current) {
                    const scrollAmount = window.innerWidth * 0.6; // Scroll roughly 60% of viewport width
                    scrollRef.current.scrollBy({
                        left: direction === 'left' ? -scrollAmount : scrollAmount,
                        behavior: 'smooth'
                    });
                }
            };

            return (
                <div className="h-full flex flex-col relative bg-slate-50">
                    <div className="absolute top-8 left-8 z-10">
                         <h2 className="text-2xl font-bold text-slate-900">Evolution Timeline</h2>
                         <p className="text-xs text-slate-500">Scroll or use buttons to explore</p>
                    </div>

                    {/* Navigation Buttons */}
                    <div className="absolute top-1/2 -translate-y-1/2 left-4 z-20 hidden md:block">
                        <button onClick={() => scroll('left')} className="w-12 h-12 rounded-full bg-white/80 backdrop-blur border border-slate-200 shadow-lg text-slate-600 hover:text-primary hover:scale-110 transition-all flex items-center justify-center">
                            <i className="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div className="absolute top-1/2 -translate-y-1/2 right-4 z-20 hidden md:block">
                        <button onClick={() => scroll('right')} className="w-12 h-12 rounded-full bg-white/80 backdrop-blur border border-slate-200 shadow-lg text-slate-600 hover:text-primary hover:scale-110 transition-all flex items-center justify-center">
                            <i className="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div ref={scrollRef} className="flex-1 flex items-center overflow-x-auto gap-8 px-8 md:px-20 snap-x snap-mandatory hide-scrollbar">
                        {timelineData.map((e, i) => (
                            <div key={i} onClick={() => setSelectedItem(e)}
                                className="snap-center shrink-0 w-[85vw] md:w-[450px] h-[65vh] bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden relative cursor-pointer group hover:-translate-y-4 transition-all duration-500 ease-out"
                            >
                                <div className="absolute inset-0">
                                    <img src={e.img} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 grayscale group-hover:grayscale-0 opacity-90 group-hover:opacity-100" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>
                                </div>
                                
                                <div className="absolute bottom-0 left-0 w-full p-8 text-white transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-5xl font-mono font-black text-white/20 group-hover:text-white/40 transition-colors">{e.year}</span>
                                        <span className="px-3 py-1 bg-primary/80 backdrop-blur rounded-full text-[10px] font-bold uppercase tracking-widest">{e.tag}</span>
                                    </div>
                                    <h3 className="text-3xl font-bold mb-3 leading-tight">{e.title}</h3>
                                    <p className="text-sm text-slate-300 line-clamp-2 opacity-0 group-hover:opacity-100 transition-opacity duration-500 delay-100 leading-relaxed">
                                        {e.desc}
                                    </p>
                                    <div className="mt-6 flex items-center gap-2 text-secondary text-xs font-bold uppercase tracking-wider opacity-0 group-hover:opacity-100 transition-all delay-200">
                                        View {e.events.length} Events <i className="fas fa-arrow-right"></i>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {/* Final Spacer with Next Button */}
                        <div className="snap-center shrink-0 w-[300px] h-[65vh] flex items-center justify-center">
                             <button onClick={onNavigateForward} className="w-20 h-20 rounded-full bg-slate-900 text-white flex items-center justify-center hover:scale-110 transition-transform shadow-2xl group">
                                <span className="group-hover:hidden"><i className="fas fa-chevron-right text-xl"></i></span>
                                <span className="hidden group-hover:inline text-xs font-bold uppercase tracking-wider">Start</span>
                             </button>
                        </div>
                    </div>

                    <button onClick={onNavigateBack} className="absolute bottom-8 left-8 text-slate-400 hover:text-slate-800 text-sm font-bold flex items-center gap-2 z-30">
                        <i className="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            );
        };

        const ConclusionScreen = ({ onRestart }) => (
            <div className="h-full flex flex-col justify-center items-center text-center px-6 relative overflow-hidden bg-white">
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-accent via-white to-white opacity-60"></div>
                
                <div className="relative z-10 animate-slide-up">
                    <div className="w-20 h-20 bg-gradient-to-br from-primary to-secondary rounded-2xl rotate-3 flex items-center justify-center text-white mb-8 mx-auto shadow-2xl shadow-primary/30">
                        <i className="fas fa-check text-3xl"></i>
                    </div>
                    
                    <h2 className="text-4xl md:text-5xl font-extrabold text-slate-900 mb-6 tracking-tight">
                        The End of Policy<br/>is the <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Start of Living</span>
                    </h2>
                    
                    <p className="text-slate-500 text-lg max-w-xl mx-auto mb-10 leading-relaxed">
                        Migration trends and checkpoint optimizations have birthed a new demographic: 
                        <span className="font-bold text-slate-800"> The Cross-Border Citizen</span>.
                    </p>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-3xl mx-auto mb-12">
                        {[
                            {icon:'fa-briefcase', t:'Commuter', d:'14min High Speed Commute'}, 
                            {icon:'fa-shopping-bag', t:'Consumer', d:'Weekend Sam\'s Club Run'}, 
                            {icon:'fa-home', t:'Resident', d:'Retiring in Zhongshan'}
                        ].map((x,i)=>(
                            <div key={i} className="bg-white/80 backdrop-blur p-4 rounded-xl border border-slate-100 shadow-lg hover:-translate-y-1 transition-transform">
                                <div className="w-10 h-10 rounded-lg bg-accent flex items-center justify-center text-primary mx-auto mb-3"><i className={`fas ${x.icon}`}></i></div>
                                <div className="font-bold text-slate-800 mb-1">{x.t}</div>
                                <div className="text-xs text-slate-500">{x.d}</div>
                            </div>
                        ))}
                    </div>

                    <button onClick={onRestart} className="px-8 py-3 rounded-full border border-slate-200 text-slate-500 hover:text-primary hover:border-primary hover:bg-accent/50 transition-all text-sm font-bold uppercase tracking-widest">
                        <i className="fas fa-undo mr-2"></i> Replay Narrative
                    </button>
                </div>
            </div>
        );

        // --- 5. ROOT CONTAINER ---

        const AppPart3 = () => {
            const [screen, setScreen] = useState(0);
            const [selectedItem, setSelectedItem] = useState(null);

            // Screen Mapping
            const renderScreen = () => {
                switch(screen) {
                    case 0: return <DashboardScreen onNavigate={() => setScreen(1)} />;
                    case 1: return <TimelineScreen onNavigateBack={() => setScreen(0)} onNavigateForward={() => setScreen(2)} setSelectedItem={setSelectedItem} />;
                    case 2: return <ConclusionScreen onRestart={() => setScreen(0)} />;
                    default: return <DashboardScreen />;
                }
            };

            return (
                <div className="w-full h-full bg-[#f8fafc] relative">
                    {/* Main Content Transition Wrapper */}
                    <div className="w-full h-full transition-opacity duration-500">
                        {renderScreen()}
                    </div>

                    {/* Modal Overlay */}
                    {selectedItem && <Modal item={selectedItem} onClose={() => setSelectedItem(null)} />}

                    {/* Navigation Dots (Visual Indicator) */}
                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-3 z-50">
                        {[0,1,2].map(i => (
                            <button key={i} onClick={()=>setScreen(i)} 
                                className={`h-1 rounded-full transition-all duration-500 ${screen===i ? 'w-8 bg-slate-800' : 'w-2 bg-slate-300 hover:bg-primary'}`} 
                            />
                        ))}
                    </div>
                </div>
            );
        };

        const root3 = ReactDOM.createRoot(document.getElementById('root-part3'));
        root3.render(<AppPart3 />);
    </script>
</body>
</html>