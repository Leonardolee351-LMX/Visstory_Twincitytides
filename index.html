<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin City Tales | A Border Chronicle</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700;900&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        borderGray: '#E5E5E5', /* Lighter border for white theme */
                        narrativeBg: '#FFFFFF', /* White background */
                        accentCyan: '#00997A', /* Darker teal for better contrast on white */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Inter', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body {
            background-color: #FFFFFF;
            color: #1A1A1A;
            overflow: hidden;
            margin: 0;
            padding: 0;
            cursor: crosshair;
        }

        /* Cinematic Scrolling Animation */
        @keyframes movieCredits {
            from { transform: translateY(100%); }
            to { transform: translateY(-130%); }
        }
        .credits-scroll {
            animation: movieCredits 50s linear infinite;
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .viewport-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Narrative Stepper Styles */
        .nav-line {
            height: 1px;
            background: rgba(0,0,0,0.1); /* Darker line for white bg */
            position: relative;
            flex-grow: 1;
        }
        .nav-dot-container {
            position: relative;
            padding: 15px; 
            margin: -15px;
            cursor: pointer;
            z-index: 60;
        }
        .nav-dot {
            width: 6px;
            height: 6px;
            background: #CCC; /* Lighter dot for inactive state */
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .nav-dot.active {
            background: #00997A;
            box-shadow: 0 0 12px rgba(0, 153, 122, 0.4);
            transform: scale(1.8);
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 8s linear infinite;
        }

        /* Archive Styles */
        .content-scroller { width: 100%; height: 100%; overflow-y: auto; padding-top: 4rem; padding-bottom: 4rem; }
        .content-scroller::-webkit-scrollbar { width: 6px; }
        .content-scroller::-webkit-scrollbar-track { background: transparent; }
        .content-scroller::-webkit-scrollbar-thumb { background: rgba(14, 116, 144, 0.1); border-radius: 3px; }
        .content-scroller::-webkit-scrollbar-thumb:hover { background: rgba(14, 116, 144, 0.3); }
        .archive-sheet { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.05); }
        .list-row { transition: all 0.2s ease; border-bottom: 1px solid rgba(226, 232, 240, 0.6); }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background: rgba(236, 254, 255, 0.6); padding-left: 1rem; padding-right: 1rem; border-radius: 8px; border-bottom-color: transparent; margin: 0 -1rem; z-index: 10; }
        .meta-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; letter-spacing: 0.05em; text-transform: uppercase; color: #64748b; display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; background: #f1f5f9; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        const NextButton = ({ onClick, text = "CONTINUE" }) => (
            <button 
                onClick={onClick}
                className="px-8 py-3 border border-black/10 hover:border-accentCyan hover:text-accentCyan text-black/80 transition-all duration-500 font-mono tracking-widest text-[10px] group bg-white/50 backdrop-blur-sm z-50 pointer-events-auto"
            >
                {text} <i className="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
            </button>
        );

        const chapters = [
            { 
                id: 0, 
                title: "Title Page", 
                subtitle: "Intro", 
                type: "hero",
                subchapters: [
                    { title: "PREFACE", stepIndex: 1 }
                ]
            },
            { id: 0.5, title: "Dissolving Borders", subtitle: "卷首语（英文）", type: "v2_intro", hiddenInNav: true },
            { 
                id: 1, 
                title: "RECOVERY", 
                subtitle: "Chapter 1\nREBOOTED BOUNDARY", 
                type: "chapter_intro", 
                chapter: "01",
                image: "images/第一章插图.jpg",
                description: [
                    "The full resumption of cross-border travel in February 2023 marked a crucial watershed in the history of Shenzhen-Hong Kong relations. The long-constrained border began to loosen, and the first to return was not a grand narrative but a sense of certainty that it was safe to venture out. ",
                    "We conducted data cleaning on the data from January 2021 to December 2025 through the open data set of the Hong Kong government and obtained the daily entry and exit figures of different control points. Through this data visualization chart, we can more clearly perceive the recovery of cross-border travel after the pandemic and the joy and rhythm of life in the northward flow of people. "
                ],
                subchapters: [
                    { title: "1.1 Recovery", url: "Chapter1.HTML" },
                    { title: "1.2 Counterflow", url: "Chapter1.HTML" }
                ]
            },
            { 
                id: 2, 
                title: "THE FOLDED CITY", 
                subtitle: "Chapter 2\nFOLDED CITY", 
                type: "chapter_intro", 
                chapter: "02",
                image: "images/第二章插图.jpg",
                description: [
                    "The end of the pandemic has triggered a rebound in consumption and travel frequency among residents of Shenzhen and Hong Kong. As the flow of people and vehicles gradually increases after the lifting of restrictions, the control points also need to be equipped with sufficient intelligence to handle the challenges posed by the huge volume of customs clearance traffic. ",
                    "From the perspectives of the development history of the border control station, the evolution of commuting patterns and the effectiveness of construction, we observe the iterative progress of this border in recent years with a historical monthly system perspective."
                ],
                subchapters: [
                    { title: "2.1 Flows", url: "Chapter2.HTML" },
                    { title: "2.2 Analysis", url: "Chapter2.HTML" },
                    { title: "2.3 Dual City", url: "Chapter2.HTML" }
                ]
            },
            { 
                id: 3, 
                title: "CONCRETE LIVES", 
                subtitle: "Chapter 3\nCONCRETE LIVES", 
                type: "chapter_intro", 
                chapter: "03",
                image: "images/第三章插图.jpg",
                description: [
                    "The development of border control points has improved clearance efficiency and made dual-city routines possible for more people. Yet faster crossing does not automatically lead to deeper integration.",
                    "They are migratory birds, ferrymen, stitches suturing two cities. All of them plan their days between speed and uncertainty. By stepping briefly into these everyday routines, we shift our focus from movement itself to the lived experience of their boundary-crossing life—how time, rhythm, and small frictions continue to shape what cross-border life actually feels like."
                ],
                subchapters: [
                    { title: "3.1 Persona", url: "Chapter3_Persona.HTML" },
                    { title: "3.2 Timeline", url: "Chapter3_Timeline.HTML" },
                    { title: "3.3 Phenomenon", url: "Chapter3_Phenomenon.HTML" }
                ]
            },
            { 
                id: 4, 
                title: "Epilogue", 
                subtitle: "Epilogue", 
                type: "credits",
                subchapters: [
                    { title: "Review", stepIndex: 5 },
                    { title: "Archive", stepIndex: 6 }
                ]
            },
            { id: 5, title: "Archive", subtitle: "Archive", type: "archive", hiddenInNav: true }
        ];

        // 1.5 V2 Intro Page
        const V2IntroPage = ({ onNext }) => (
            <div className="viewport-container text-center px-6 bg-[#F9FAFB]">
                <div className="absolute inset-0 z-0 overflow-hidden opacity-10">
                    <div className="w-full h-full bg-[url('https://images.unsplash.com/photo-1541410945376-a7872f540035?auto=format&fit=crop&q=80&w=2000')] bg-cover bg-center grayscale"></div>
                </div>
                <div className="relative z-10 max-w-4xl mx-auto">
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 1.5 }}>
                        <div className="font-mono text-accentCyan tracking-[0.4em] text-[9px] mb-8 uppercase">2023 - 2025 BORDER CHRONICLE</div>
                        
                        <h1 className="text-5xl md:text-7xl font-black tracking-tighter leading-tight mb-2 text-gray-900 font-serif">
                            Dissolving Borders
                        </h1>
                        <h2 className="text-3xl md:text-5xl font-light tracking-tight mb-10 text-gray-300 font-serif">
                            Symbiotic Living
                        </h2>
                        
                        <div className="max-w-xl mx-auto mb-16 text-left md:text-center">
                            <div className="h-px w-8 bg-accentCyan mx-auto mb-8 hidden md:block"></div>
                            
                            <div className="space-y-6">
                                <p className="text-xs md:text-sm text-gray-600 font-light leading-loose font-serif">
                                    298 million round trips have delivered the era's answer: Shenzhen and Hong Kong are moving from physical neighbors to emotional and lifestyle 'city-mates'. This momentum, like an irreversible tide, stitches the future of every ordinary person together.
                                </p>
                                <p className="text-xs md:text-sm text-gray-600 font-light leading-loose font-serif">
                                    While accelerated integration brings subtle frictions—efficiency gaps and questions of belonging—these growing pains will gradually smooth out as the "One-Hour Living Circle" matures.
                                </p>
                            </div>

                            <div className="mt-8 pt-8 border-t border-gray-200/60">
                                <p className="text-accentCyan/90 font-serif italic text-xs md:text-sm leading-relaxed">
                                    "The border transforms from a dividing line into a vibrant confluence.<br/>
                                    Every crossing measures the arrival of a borderless era.<br/>
                                    In the future, there is no 'cross-border', only 'living'."
                                </p>
                            </div>
                        </div>

                        <button 
                            onClick={onNext}
                            className="px-6 py-2 border border-black/10 hover:border-accentCyan hover:text-accentCyan transition-all duration-500 font-mono tracking-widest text-[9px] group text-gray-800"
                        >
                            ENTERING THE BORDER <i className="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                        </button>
                    </motion.div>
                </div>
            </div>
        );

        // 1. Hero Page (Modified for White Mode)
        const HeroPage = ({ onNext }) => (
            <div className="viewport-container text-center px-6">
                <div className="absolute inset-0 z-0 overflow-hidden opacity-10">
                    <div className="w-full h-full bg-[url('https://images.unsplash.com/photo-1541410945376-a7872f540035?auto=format&fit=crop&q=80&w=2000')] bg-cover bg-center grayscale"></div>
                </div>
                <div className="relative z-10">
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 1.5 }}>
                        <div className="font-mono text-accentCyan tracking-[0.6em] text-xs mb-6 uppercase">2023 - 2025 BORDER CHRONICLE</div>
                        <h1 className="text-5xl md:text-8xl font-black tracking-tighter leading-none mb-4 text-black">Twin City Tales</h1>
                        <h2 className="text-xl md:text-3xl font-light font-serif text-black/60 tracking-[0.3em] mb-12">Lives across the Shenzhen<br />‑Hong Kong Border</h2>
                        <button 
                            onClick={onNext}
                            className="px-8 py-3 border border-black/10 hover:border-accentCyan hover:text-accentCyan text-black/80 transition-all duration-500 font-mono tracking-widest text-[10px] group"
                        >
                            ENTERING THE BORDER <i className="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                        </button>
                    </motion.div>
                </div>
            </div>
        );

        // 2. Chapter Intro (Modified for White Mode)
        const FloatingCard = ({ title, titleEn, quote, x, y, delay, type }) => {
            const [isActive, setIsActive] = useState(false);
            
            // Define colors based on type (SZ=Blue, HK=Green)
            const isSZ = type === 'SZ';
            const bgColor = isSZ ? 'bg-blue-500/10' : 'bg-emerald-500/10';
            const iconColor = isSZ ? 'text-blue-600' : 'text-emerald-600';
            const borderColor = isSZ ? 'border-blue-500/20' : 'border-emerald-500/20';

            return (
                <motion.div 
                    drag
                    dragConstraints={{ left: -100, right: 100, top: -100, bottom: 100 }}
                    onDragStart={() => setIsActive(true)}
                    onDragEnd={() => setIsActive(false)}
                    onHoverStart={() => setIsActive(true)}
                    onHoverEnd={() => setIsActive(false)}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ 
                        opacity: 1, 
                        y: [0, -10, 0],
                        zIndex: isActive ? 50 : 0
                    }}
                    transition={{ 
                        opacity: { delay: delay, duration: 0.8 },
                        y: { repeat: Infinity, duration: 3 + Math.random() * 2, ease: "easeInOut", delay: delay },
                        zIndex: { duration: 0 }
                    }}
                    style={{ left: x, top: y }}
                    className={`absolute hidden md:flex flex-col p-4 bg-white/90 backdrop-blur-sm border ${borderColor} rounded-xl shadow-sm w-48 cursor-grab active:cursor-grabbing group hover:bg-white/95 transition-colors duration-300`}
                >
                    <div className={`w-8 h-8 rounded-full ${bgColor} mb-2 flex items-center justify-center pointer-events-none`}>
                        <i className={`fas fa-user ${iconColor} text-xs`}></i>
                    </div>
                    <div className="font-medium text-slate-800 text-sm pointer-events-none mb-1 uppercase tracking-wide">{titleEn}</div>
                    
                    {/* Opinion Tooltip */}
                    <AnimatePresence>
                        {isActive && (
                            <motion.div
                                initial={{ opacity: 0, scale: 0.9, y: 10 }}
                                animate={{ opacity: 1, scale: 1, y: 0 }}
                                exit={{ opacity: 0, scale: 0.9, y: 5 }}
                                className={`absolute top-full left-0 mt-2 w-56 p-3 bg-white/90 backdrop-blur-md rounded-lg shadow-xl border ${borderColor} z-50 pointer-events-none`}
                            >
                                <div className="absolute -top-1 left-6 w-2 h-2 bg-white/90 transform rotate-45 border-t border-l border-slate-200"></div>
                                <p className="text-[10px] leading-relaxed text-slate-600 font-serif italic">
                                    "{quote}"
                                </p>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
            );
        };

        const ChapterIntro = ({ data, onNext }) => {
            const isFaces = data.id === 3; // Identified by ID for stability
            const paragraphs = data.description || [];
            
            const cards = [
                { 
                    title: "跨境学童", 
                    titleEn: "Cross-border Student", 
                    x: "10%", 
                    y: "20%",
                    quote: "The Shenzhen-Hong Kong border is like a magic door to me. One side holds the delicious warmth of home cooking; the other, the strict discipline of school.",
                    type: "SZ"
                },
                { 
                    title: "深港通勤族", 
                    titleEn: "SZ-HK Commuters", 
                    x: "75%", 
                    y: "15%",
                    quote: "The border defines my existence. It's a calculated trade-off between high income and living costs. Sometimes I feel like a pendulum.",
                    type: "SZ"
                },
                { 
                    title: "周末特种兵", 
                    titleEn: "Weekend Raiders", 
                    x: "80%", 
                    y: "60%",
                    quote: "As a consumer, the border is the line of 'cost-performance ratio'. I hope payment and logistics will be fully integrated soon.",
                    type: "HK"
                },
                { 
                    title: "北上安老长者", 
                    titleEn: "Elderly Moving North", 
                    x: "15%", 
                    y: "70%",
                    quote: "Retirement in the Greater Bay Area means dignity. My pension stretches further here—spacious gardens and attentive care that were impossible dreams in Hong Kong.",
                    type: "HK"
                },
                { 
                    title: "留学硕博通勤者", 
                    titleEn: "Postgrad Commuters", 
                    x: "60%", 
                    y: "80%",
                    quote: "The border is like a filter. It filters out Shenzhen's noise so I can study, and HK's stress so I can rest. But it also blurs my sense of belonging.",
                    type: "SZ"
                },
                { 
                    title: "远程协作人", 
                    titleEn: "Remote Collaborators", 
                    x: "45%", 
                    y: "55%",
                    quote: "My office is in the cloud, my home is in Shenzhen. The border is just a checkpoint for client meetings, not a barrier to my daily life.",
                    type: "SZ"
                },
                { 
                    title: "商务精英", 
                    titleEn: "Business Elite", 
                    x: "50%", 
                    y: "10%",
                    quote: "Time is the only currency that matters. The high-speed rail and E-channel make the border invisible, turning two cities into one giant business district.",
                    type: "HK"
                },
                { 
                    title: "生活探索者", 
                    titleEn: "Life Explorer", 
                    x: "85%", 
                    y: "35%",
                    quote: "I don't belong to one city. I belong to the flow. Shenzhen's tech vibrancy and Hong Kong's cultural depth—why choose when I can have both?",
                    type: "HK"
                }
            ];

            return (
                <div className="viewport-container px-12 md:px-32 justify-start relative overflow-hidden bg-white">
                    
                    {/* Background Image Container on the RIGHT 
                        使用 clip-path 替代 skew，确保斜线从顶到底绝对笔直
                    */}
                    <div 
                        className="absolute right-0 top-0 h-full w-[70%] z-0" 
                        style={{ clipPath: "polygon(20% 0, 100% 0, 100% 100%, 0% 100%)" }}
                    >
                        {/* Image */}
                        <img 
                            src={data.image} 
                            alt={data.title}
                            className="absolute inset-0 w-full h-full object-cover grayscale-[5%] opacity-100"
                        />
                        
                        {/* Overlays for texture and text readability */}
                        <div className="absolute inset-0 bg-accentCyan/5 mix-blend-multiply pointer-events-none"></div>
                        <div className="absolute inset-0 bg-gradient-to-l from-transparent to-white/10 pointer-events-none"></div>
                    </div>
                    
                    {/* Floating Cards for Faces Chapter */}
                    {isFaces && cards.map((card, i) => (
                        <FloatingCard key={i} {...card} delay={0.5 + i * 0.1} />
                    ))}

                    <div className="relative z-10 max-w-4xl text-left">
                        <motion.div initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 1 }}>
                            <div className="flex items-center gap-4 mb-8">
                                <span className="text-3xl font-mono text-gray-300">{data.chapter}</span>
                                <div className="h-px w-12 bg-accentCyan"></div>
                            </div>
                            
                            <div className="mb-8">
                                {data.subtitle && (
                                    <div className="text-accentCyan font-mono tracking-[0.3em] uppercase text-[9px] mb-3">
                                        {data.subtitle}
                                    </div>
                                )}
                                <h2 className="text-4xl md:text-6xl font-sans font-black tracking-tight text-[#00997A] uppercase leading-[0.9]">
                                    {data.title}
                                </h2>
                            </div>
                            
                            {/* Standardized layout for all chapters including Faces */}
                            <div className="max-w-md border-l border-accentCyan/20 pl-6 ml-1 bg-white/80 backdrop-blur-sm p-4 rounded-r-lg md:p-6 md:pl-8 mb-12 shadow-sm"> 
                                {paragraphs.map((para, index) => (
                                    <p 
                                        key={index} 
                                        className="mb-5 last:mb-0 leading-loose text-gray-500 font-light font-serif text-xs md:text-sm text-justify"
                                        dangerouslySetInnerHTML={{__html: para}}
                                    />
                                ))}
                            </div>
                            
                            <NextButton onClick={() => {
                        if (data.id === 1) window.location.href = 'Chapter1.HTML';
                        else if (data.id === 2) window.location.href = 'Chapter2.HTML';
                        else if (data.id === 3) window.location.href = 'Chapter3_Persona.HTML';
                        else onNext();
                    }} text="ENTER CHAPTER" />
                        </motion.div>
                    </div>
                </div>
            );
        };

        const onNext = () => {
             // Logic to handle next step if needed
        };

        // 3. Data Viz (Integrated Chapter1.HTML)
        const DataVizPage = ({ onNext }) => (
            <div className="viewport-container w-full h-full relative">
                <iframe 
                    src="Chapter1.HTML" 
                    className="w-full h-full border-0" 
                    title="The Resurgence"
                />
                <div className="absolute bottom-8 right-8 z-50">
                    <NextButton onClick={onNext} text="NEXT CHAPTER" />
                </div>
            </div>
        );

        // 4. Split View (Integrated Chapter2.HTML)
        const SplitViewPage = ({ onNext }) => (
            <div className="viewport-container w-full h-full relative">
                <iframe 
                    src="Chapter2.HTML" 
                    className="w-full h-full border-0" 
                    title="Folding Time Analysis"
                />
                <div className="absolute bottom-8 right-8 z-50">
                    <NextButton onClick={onNext} text="NEXT CHAPTER" />
                </div>
            </div>
        );

        // 5. Persona Grid (Integrated Navigation for People)
        const PersonaGrid = () => {
            const [activePage, setActivePage] = useState(null);

            const pages = [
                { id: '3-1', title: 'Cross-Temporal', subtitle: 'Analysis', url: '3-1.html', desc: 'Space-time evolution of border crossings.' },
                { id: '3-2', title: 'Persona', subtitle: 'Profiles', url: 'Chapter3_Persona.HTML', desc: 'Individual stories from the commuter tide.' },
                { id: '3-3', title: 'Timeline', subtitle: 'Cross-Border', url: 'Chapter3_Timeline.HTML', desc: 'A day in the life of the twin cities.' },
                { id: '4-1', title: 'Future', subtitle: 'Questions', url: '4-1future_question.html', desc: 'Emerging issues and future outlooks.' },
            ];

            return (
                <div className="viewport-container w-full h-full relative">
                    <AnimatePresence mode="wait">
                        {activePage ? (
                            <motion.div 
                                key="detail"
                                initial={{ opacity: 0, scale: 0.95 }}
                                animate={{ opacity: 1, scale: 1 }}
                                exit={{ opacity: 0, scale: 0.95 }}
                                className="w-full h-full bg-white relative"
                            >
                                <button 
                                    onClick={() => setActivePage(null)}
                                    className="absolute top-4 right-4 z-50 px-4 py-2 bg-white/90 backdrop-blur border border-black/10 rounded-full text-[10px] font-mono uppercase tracking-widest hover:bg-black/5 hover:text-accentCyan transition-colors shadow-sm"
                                >
                                    <i className="ph ph-x mr-2"></i>Close View
                                </button>
                                <iframe src={activePage} className="w-full h-full border-0" title="Detail View" />
                            </motion.div>
                        ) : (
                            <motion.div 
                                key="grid"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                className="w-full h-full flex items-center justify-center p-8 md:p-20"
                            >
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-5xl">
                                    {pages.map((page, index) => (
                                        <div 
                                            key={page.id}
                                            onClick={() => setActivePage(page.url)}
                                            className="group relative overflow-hidden bg-white border border-black/5 hover:border-accentCyan/50 transition-all duration-500 cursor-pointer h-64 flex flex-col justify-between p-8 hover:shadow-xl hover:-translate-y-1"
                                        >
                                            <div className="absolute top-0 right-0 w-24 h-24 bg-accentCyan/5 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-150 duration-700"></div>
                                            
                                            <div>
                                                <div className="font-mono text-[10px] text-black/40 tracking-widest uppercase mb-3">{page.subtitle}</div>
                                                <h3 className="font-medium font-serif text-3xl text-black/80 group-hover:text-accentCyan transition-colors duration-300">{page.title}</h3>
                                            </div>
                                            
                                            <div className="flex justify-between items-end">
                                                <p className="text-xs text-black/50 max-w-[70%] font-sans leading-relaxed">{page.desc}</p>
                                                <div className="w-10 h-10 rounded-full border border-black/10 flex items-center justify-center group-hover:bg-accentCyan group-hover:text-white group-hover:border-transparent transition-all duration-300">
                                                    <i className="ph ph-arrow-right"></i>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        // 6. Epilogue (Modified for Static Text)
        const CreditsPage = () => (
            <div className="viewport-container bg-white flex items-center justify-center">
                <div className="max-w-3xl px-8 text-center">
                    <div className="text-accentCyan font-mono text-[10px] tracking-[0.5em] mb-8 uppercase">Epilogue</div>
                    <h2 className="text-4xl md:text-5xl font-bold font-serif mb-12 tracking-widest uppercase text-black">
                        <span data-zh="边界消融，生活共生" data-en="Border Dissolution, Life Symbiosis">Border Dissolution, Life Symbiosis</span>
                    </h2>
                    
                    <div className="space-y-8 text-black/70 font-serif leading-loose text-lg md:text-xl">
                        <p>
                            <span data-zh="2.98 亿次的往返，已经给出了时代的答案：边界逐渐成为双向交流的窗口，疫情后的深港两地正从物理上的“邻居”，真正走向情感与生活上的“同城”。这种融合的势头，如同不可逆转的潮汐，将每一个普通人的未来紧密缝合。" 
                                  data-en="298 million crossings have delivered the era's verdict: the border is evolving from a barrier into a window for two-way exchange. Post-pandemic, Shenzhen and Hong Kong are transitioning from physical 'neighbors' to genuine 'city-mates' in emotion and lifestyle. This integration, like an irreversible tide, stitches together the future of every individual.">
                                298 million crossings have delivered the era's verdict: the border is evolving from a barrier into a window for two-way exchange. Post-pandemic, Shenzhen and Hong Kong are transitioning from physical "neighbors" to genuine "city-mates" in emotion and lifestyle. This integration, like an irreversible tide, stitches together the future of every individual.
                            </span>
                        </p>
                        <p>
                            <span data-zh="虽然在加速融合的过程中，我们仍需面对链路效率与生活归属感等细微的褶皱，还要跨越一大片的荒野。但这些成长的阵痛，终将在“一小时生活圈”的完善中逐渐抚平。这里的每一步往返，都在丈量一个无界时代的到来。 未来，不再有“跨境”，只有“生活”。" 
                                  data-en="While we still face wrinkles in efficiency and belonging—a wilderness yet to be crossed—these growing pains will eventually smooth out within the perfecting 'One Hour Living Circle.' Every step back and forth measures the arrival of a borderless era. In the future, there will be no 'cross-border,' only 'living.'">
                                While we still face wrinkles in efficiency and belonging—a wilderness yet to be crossed—these growing pains will eventually smooth out within the perfecting "One Hour Living Circle." Every step back and forth measures the arrival of a borderless era. In the future, there will be no "cross-border," only "living."
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        );

        // --- PARTICLE BACKGROUND (Ported from Reference.html) ---
        const ParticleBackground = () => {
            const mountRef = useRef(null);
            useEffect(() => {
                if(!mountRef.current) return;
                
                // Setup Canvas
                const canvas = document.createElement('canvas');
                canvas.style.position = 'fixed';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.zIndex = '0'; 
                canvas.style.pointerEvents = 'none';
                mountRef.current.appendChild(canvas);

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                // Particles
                const particlesGeometry = new THREE.BufferGeometry();
                const particlesCount = 800; 
                const posArray = new Float32Array(particlesCount * 3);
                for(let i = 0; i < particlesCount * 3; i++) {
                    posArray[i] = (Math.random() - 0.5) * 45; 
                }
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                
                // Material - using accentCyan color #00997A
                const material = new THREE.PointsMaterial({ size: 0.04, color: 0x00997A, transparent: true, opacity: 0.4 });
                const particlesMesh = new THREE.Points(particlesGeometry, material);
                scene.add(particlesMesh);
                camera.position.z = 12;

                // Animation
                let animationId;
                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    particlesMesh.rotation.y += 0.0002; 
                    renderer.render(scene, camera);
                };
                animate();

                // Resize
                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                // Cleanup
                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationId);
                    mountRef.current && mountRef.current.removeChild(canvas);
                    particlesGeometry.dispose();
                    material.dispose();
                    renderer.dispose();
                };
            }, []);
            return <div ref={mountRef} className="fixed inset-0 pointer-events-none z-0" />;
        };

        // --- DATA for Archive ---
        const referenceData = [
            {
                title: "Daily Passenger Traffic Statistics",
                source: "data.gov.hk",
                url: "https://data.gov.hk/en-data/dataset/hk-immd-set5-statistics-daily-passenger-traffic",
                category: "Raw Dataset"
            },
            {
                title: "Passenger, Visitor and Vehicular Traffic",
                source: "data.gov.hk",
                url: "https://data.gov.hk/en-data/dataset/hk-immd-set5-statistics-passenger-visitor-vehicular-traffic",
                category: "Raw Dataset"
            },
            {
                title: "Immigration Clearance Statistics",
                source: "Immigration Department",
                url: "https://www.immd.gov.hk/hks/facts/passenger-statistics-menu.html",
                category: "Official Report"
            },
            {
                title: "List of Immigration Control Points",
                source: "Wikipedia",
                url: "https://zh.wikipedia.org/wiki/%E9%A6%99%E6%B8%AF%E5%87%BA%E5%85%A5%E5%A2%83%E7%AE%A1%E5%88%B6%E7%AB%99%E5%88%97%E8%A1%A8",
                category: "Reference"
            },
            {
                title: "Immigration Control Points Info",
                source: "GovHK",
                url: "https://www.gov.hk/en/residents/immigration/control/index.htm",
                category: "Official Guide"
            },
            {
                title: "Cross-boundary Travel Survey 2017",
                source: "Planning Department",
                url: "https://data.gov.hk/en-data/dataset/hk-pland-pland1-cross-boundary-travel-survey-2017",
                category: "Research Paper"
            },
            {
                title: "Cross-boundary Travel Survey 2021",
                source: "Planning Department",
                url: "https://data.gov.hk/en-data/dataset/hk-pland-pland1-cross-boundary-travel-survey-2017",
                category: "Research Paper"
            }
        ];

        // 7. Archive Page Component
        const ArchivePage = () => {
            return (
                <div className="viewport-container bg-[#f8fafc]">
                    <ParticleBackground />
                    
                    {/* Inner Scroller */}
                    <div className="content-scroller relative z-10">
                        <div className="max-w-4xl mx-auto px-6">
                            
                            {/* MAIN SHEET CONTAINER */}
                            <motion.div 
                                initial={{ opacity: 0, y: 30 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ duration: 0.8 }}
                                className="archive-sheet rounded-3xl p-8 md:p-12 flex flex-col gap-12 mb-12"
                            >
                                
                                {/* 1. Header & Abstract */}
                                <section>
                                    <div className="flex justify-between items-start border-b border-slate-200 pb-6 mb-8">
                                        <div>
                                            <div className="font-mono text-xs font-bold text-accentCyan tracking-widest mb-2 uppercase flex items-center gap-2">
                                                <div className="w-2 h-2 rounded-full bg-accentCyan animate-pulse"></div>
                                                Final Report
                                            </div>
                                            <h1 className="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter font-serif">Twin City Tales</h1>
                                        </div>
                                        <div className="hidden md:block text-right">
                                            <div className="font-mono text-[10px] text-slate-400">ARCHIVE ID: 2025-HK-SZ</div>
                                            <div className="font-mono text-[10px] text-slate-400">STATUS: COMPLETE</div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col md:flex-row gap-8">
                                        <div className="md:w-1/4">
                                            <div className="font-mono text-[10px] text-slate-400 uppercase tracking-widest font-bold">Abstract</div>
                                        </div>
                                        <div className="md:w-3/4">
                                            <p className="font-serif text-lg md:text-xl text-slate-700 leading-relaxed italic">
                                                "This project visualizes the flow and interaction between Shenzhen and Hong Kong. From physical barriers to intelligent nodes, we trace the evolution of the <span className="text-accentCyan font-bold not-italic">One-Hour Living Circle</span>."
                                            </p>
                                        </div>
                                    </div>
                                </section>

                                {/* 3. Data Sources */}
                                <section className="border-t border-slate-200 pt-8 flex-1">
                                    <div className="flex flex-col md:flex-row gap-8 h-full">
                                        <div className="md:w-1/4">
                                            <div className="font-mono text-[10px] text-slate-400 uppercase tracking-widest font-bold sticky top-8">
                                                Data Index
                                            </div>
                                        </div>
                                        <div className="md:w-3/4">
                                            <div className="flex flex-col">
                                                {/* List Header */}
                                                <div className="flex pb-2 border-b border-slate-200 text-[9px] font-bold uppercase tracking-widest text-slate-400 mb-2 pl-2">
                                                    <div className="flex-1">Source Title</div>
                                                    <div className="hidden sm:block w-24 text-right pr-4">Category</div>
                                                </div>

                                                {/* List Items */}
                                                {referenceData.map((item, idx) => (
                                                    <a 
                                                        key={idx}
                                                        href={item.url}
                                                        target="_blank"
                                                        className="list-row py-3 flex items-center justify-between group cursor-pointer text-slate-700 hover:text-accentCyan"
                                                    >
                                                        <div className="flex-1 pr-4">
                                                            <div className="font-bold text-sm group-hover:translate-x-1 transition-transform">
                                                                {item.title}
                                                            </div>
                                                            <div className="font-mono text-[9px] text-slate-400 mt-0.5 uppercase group-hover:text-accentCyan/60">
                                                                {item.source}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <span className="meta-tag hidden sm:inline-flex bg-white border border-slate-200 text-slate-400 group-hover:border-accentCyan/30 group-hover:text-accentCyan/70">
                                                                {item.category}
                                                            </span>
                                                            <i className="fas fa-external-link-alt text-[10px] text-slate-300 group-hover:text-accentCyan transition-colors"></i>
                                                        </div>
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* Footer */}
                                <div className="text-center pt-8 text-[10px] font-mono text-slate-300 uppercase tracking-widest">
                                    Twin City Chronicles Archive © 2025
                                </div>

                            </motion.div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Global Navigation Component ---
        const GlobalNav = ({ chapters, currentStep, onNavigate }) => {
            // Filter out hidden chapters but keep track of original index for navigation
            const navItems = chapters
                .map((chapter, index) => ({ ...chapter, originalIndex: index }))
                .filter(chapter => !chapter.hiddenInNav);

            // Determine if a nav item is active (either it's the current step, or the current step is a hidden child of it)
            // Logic: A nav item is active if currentStep matches its originalIndex, 
            // OR if currentStep is one of its subchapters' stepIndex.
            const isItemActive = (item) => {
                if (currentStep === item.originalIndex) return true;
                if (item.subchapters && item.subchapters.some(sub => sub.stepIndex === currentStep)) return true;
                return false;
            };

            return (
                <nav className="fixed bottom-0 left-0 w-full z-[100] flex justify-center pb-12 pt-20 bg-gradient-to-t from-white via-white/90 to-transparent pointer-events-none">
                    <div className="flex items-end gap-12 md:gap-24 pointer-events-auto">
                        {navItems.map((chapter) => {
                            const active = isItemActive(chapter);
                            
                            return (
                                <div key={chapter.id} className="relative group flex flex-col items-center">
                                    {/* Main Click Area (Label + Dot) */}
                                    <div 
                                        className="flex flex-col items-center cursor-pointer"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            onNavigate(chapter.originalIndex);
                                        }}
                                    >
                                        {/* Label */}
                                        <div className={`text-[10px] font-mono tracking-widest uppercase transition-colors duration-300 whitespace-pre-line text-center leading-tight ${active ? 'text-accentCyan font-bold' : 'text-black/40 group-hover:text-black/80'}`}>
                                            {chapter.subtitle}
                                        </div>
                                        
                                        {/* Dot */}
                                        <div className={`w-2 h-2 rounded-full mt-3 transition-all duration-300 ${active ? 'bg-accentCyan scale-125' : 'bg-black/20 group-hover:bg-black/40'}`}></div>
                                    </div>

                                    {/* Sub-menu Container */}
                                    {chapter.subchapters && (
                                        <div 
                                            className="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col-reverse items-center transition-all duration-300 pointer-events-none group-hover:pointer-events-auto"
                                            onClick={(e) => e.stopPropagation()}
                                        >
                                            {/* The Line */}
                                            <div className="w-px h-[16rem] bg-gradient-to-t from-accentCyan/50 to-transparent origin-bottom scale-y-0 group-hover:scale-y-100 transition-transform duration-500 ease-out"></div>
                                            
                                            {/* Sub-items Container - positioned absolutely along the line */}
                                            <div 
                                                className="absolute bottom-0 w-64 h-[16rem] flex flex-col-reverse justify-around items-center pt-6 pb-12"
                                                onClick={(e) => e.stopPropagation()}
                                            >
                                                {chapter.subchapters.map((sub, subIndex) => (
                                                    <div 
                                                        key={subIndex} 
                                                        className="relative flex items-center justify-center w-full transform translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 cursor-pointer"
                                                        style={{ transitionDelay: `${150 + subIndex * 100}ms` }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            if (sub.stepIndex !== undefined) {
                                                                onNavigate(sub.stepIndex);
                                                            } else {
                                                                window.location.href = sub.url;
                                                            }
                                                        }}
                                                    >
                                                        {/* Label */}
                                                        <div className={`bg-white/80 backdrop-blur-sm px-6 py-2 rounded-xl text-xs font-mono tracking-widest uppercase border border-slate-200 transition-all duration-300 cursor-pointer hover:scale-110 whitespace-nowrap ${currentStep === sub.stepIndex ? 'text-accentCyan font-bold' : 'text-slate-400 font-medium hover:text-accentCyan hover:font-bold'}`}>
                                                            {sub.title}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </nav>
            );
        };

        // --- Main App Component ---

        const App = () => {
            const [step, setStep] = useState(0);
            const [direction, setDirection] = useState(1);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const stepParam = params.get('step');
                if (stepParam !== null) {
                    const targetStep = parseInt(stepParam, 10);
                    if (!isNaN(targetStep) && targetStep >= 0 && targetStep < chapters.length) {
                        setStep(targetStep);
                    }
                }
            }, []);

            const goToStep = (target) => {
                if (target === step) return;
                setDirection(target > step ? 1 : -1);
                setStep(target);
            };

            const next = () => { if (step < chapters.length - 1) goToStep(step + 1); };
            const prev = () => { if (step > 0) goToStep(step - 1); };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') next();
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') prev();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [step]);

            return (
                <div className="w-screen h-screen bg-narrativeBg select-none overflow-hidden flex flex-col relative">
                    
                    {/* Global Navigation */}
                    <GlobalNav chapters={chapters} currentStep={step} onNavigate={goToStep} />

                    {/* Top Progress Indicator (Modified for White Mode) */}
                    <header className="fixed top-10 left-10 z-[100] pointer-events-none">
                        <div className="font-mono text-[9px] tracking-[0.6em] text-black/40 uppercase">
                            INDEX {step.toString().padStart(2, '0')} / {chapters[step].title.toUpperCase()}
                        </div>
                    </header>

                    {/* Content Layer */}
                    <main className="flex-1 relative z-10">
                        <AnimatePresence mode="wait" custom={direction}>
                            <motion.div
                                key={step}
                                custom={direction}
                                initial={{ opacity: 0, x: direction * 40 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -direction * 40 }}
                                transition={{ duration: 0.9, ease: [0.16, 1, 0.3, 1] }}
                                className="absolute inset-0"
                            >
                                {step === 0 && <HeroPage onNext={next} />}
                                {chapters[step].type === "v2_intro" && <V2IntroPage onNext={next} />}
                                {chapters[step].type === "chapter_intro" && <ChapterIntro data={chapters[step]} />}
                                {chapters[step].type === "data_viz" && <DataVizPage />}
                                {chapters[step].type === "split_view" && <SplitViewPage />}
                                {chapters[step].type === "persona_grid" && <PersonaGrid />}
                                {chapters[step].type === "credits" && <CreditsPage />}
                                {chapters[step].type === "archive" && <ArchivePage />}
                            </motion.div>
                        </AnimatePresence>
                    </main>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>